# æµ‹è¯•è®¡åˆ’ - WayForPay æ”¯ä»˜æµç¨‹ä¼˜åŒ–

**æµ‹è¯•æ—¥æœŸ**: 2025-12-24
**æµ‹è¯•èŒƒå›´**: æ”¯ä»˜æµç¨‹ã€çŠ¶æ€ç®¡ç†ã€é€€æ¬¾åŠŸèƒ½ã€ç®¡ç†å‘˜åŠŸèƒ½
**æµ‹è¯•ç¯å¢ƒ**: Development, Staging, Production

---

## ğŸ“‹ ç›®å½•

1. [æ•°æ®åº“å±‚æµ‹è¯•](#æ•°æ®åº“å±‚æµ‹è¯•)
2. [WayForPay é›†æˆæµ‹è¯•](#wayforpay-é›†æˆæµ‹è¯•)
3. [å‰ç«¯é”™è¯¯å¤„ç†æµ‹è¯•](#å‰ç«¯é”™è¯¯å¤„ç†æµ‹è¯•)
4. [é€€æ¬¾æµç¨‹æµ‹è¯•](#é€€æ¬¾æµç¨‹æµ‹è¯•)
5. [ç®¡ç†å‘˜åŠŸèƒ½æµ‹è¯•](#ç®¡ç†å‘˜åŠŸèƒ½æµ‹è¯•)
6. [UI ç»„ä»¶æµ‹è¯•](#ui-ç»„ä»¶æµ‹è¯•)
7. [ç«¯åˆ°ç«¯æµ‹è¯•åœºæ™¯](#ç«¯åˆ°ç«¯æµ‹è¯•åœºæ™¯)
8. [å›å½’æµ‹è¯•](#å›å½’æµ‹è¯•)
9. [æ€§èƒ½æµ‹è¯•](#æ€§èƒ½æµ‹è¯•)
10. [å®‰å…¨æµ‹è¯•](#å®‰å…¨æµ‹è¯•)

---

## 1. æ•°æ®åº“å±‚æµ‹è¯•

### 1.1 çŠ¶æ€çº¦æŸæµ‹è¯•

**æ–‡ä»¶**: `supabase/migrations/20251224000000_add_donation_status_constraints.sql`

#### æµ‹è¯•ç”¨ä¾‹ 1.1.1: åˆæ³•çŠ¶æ€æ’å…¥
```sql
-- æµ‹è¯•æ‰€æœ‰16ä¸ªçŠ¶æ€éƒ½èƒ½æˆåŠŸæ’å…¥
DO $$
DECLARE
  valid_statuses TEXT[] := ARRAY[
    'pending', 'widget_load_failed', 'user_cancelled',
    'processing', 'fraud_check',
    'paid', 'confirmed', 'delivering', 'completed',
    'expired', 'declined', 'failed',
    'refunding', 'refund_processing', 'refunded'
  ];
  test_status TEXT;
BEGIN
  FOREACH test_status IN ARRAY valid_statuses LOOP
    INSERT INTO donations (
      donation_public_id, project_id, donor_name, donor_email,
      amount, currency, donation_status, order_reference
    ) VALUES (
      'TEST-' || test_status,
      1,
      'Test User',
      'test@example.com',
      100,
      'USD',
      test_status,
      'TEST-ORDER-' || test_status
    );

    RAISE NOTICE 'âœ“ Status % inserted successfully', test_status;
  END LOOP;

  -- æ¸…ç†æµ‹è¯•æ•°æ®
  DELETE FROM donations WHERE donation_public_id LIKE 'TEST-%';
END $$;
```

**é¢„æœŸç»“æœ**: âœ… æ‰€æœ‰16ä¸ªçŠ¶æ€éƒ½èƒ½æˆåŠŸæ’å…¥

---

#### æµ‹è¯•ç”¨ä¾‹ 1.1.2: éæ³•çŠ¶æ€æ‹’ç»
```sql
-- æµ‹è¯•éæ³•çŠ¶æ€ä¼šè¢«æ‹’ç»
DO $$
BEGIN
  BEGIN
    INSERT INTO donations (
      donation_public_id, project_id, donor_name, donor_email,
      amount, currency, donation_status, order_reference
    ) VALUES (
      'TEST-INVALID',
      1,
      'Test User',
      'test@example.com',
      100,
      'USD',
      'invalid_status',  -- âŒ éæ³•çŠ¶æ€
      'TEST-ORDER'
    );

    RAISE EXCEPTION 'âš ï¸ Test failed: invalid status was accepted';
  EXCEPTION
    WHEN check_violation THEN
      RAISE NOTICE 'âœ“ Invalid status correctly rejected';
  END;
END $$;
```

**é¢„æœŸç»“æœ**: âœ… æŠ›å‡º `check_violation` å¼‚å¸¸

---

### 1.2 ç®¡ç†å‘˜æƒé™é™åˆ¶æµ‹è¯•

**æ–‡ä»¶**: `supabase/migrations/20251224120000_restrict_admin_status_updates.sql`

#### æµ‹è¯•ç”¨ä¾‹ 1.2.1: ç®¡ç†å‘˜åˆæ³•çŠ¶æ€è½¬æ¢
```sql
-- è®¾ç½®ç®¡ç†å‘˜ context (æ¨¡æ‹Ÿ authenticated ç”¨æˆ·)
SET LOCAL role TO authenticated;
SET LOCAL request.jwt.claim.sub TO 'test-admin-uuid';

-- æµ‹è¯• paid â†’ confirmed
UPDATE donations
SET donation_status = 'confirmed'
WHERE donation_public_id = 'TEST-PAID-001'
  AND donation_status = 'paid';
-- âœ… åº”è¯¥æˆåŠŸ

-- æµ‹è¯• confirmed â†’ delivering
UPDATE donations
SET donation_status = 'delivering'
WHERE donation_public_id = 'TEST-CONFIRMED-001'
  AND donation_status = 'confirmed';
-- âœ… åº”è¯¥æˆåŠŸ

-- æµ‹è¯• delivering â†’ completed
UPDATE donations
SET donation_status = 'completed'
WHERE donation_public_id = 'TEST-DELIVERING-001'
  AND donation_status = 'delivering';
-- âœ… åº”è¯¥æˆåŠŸ

RESET role;
```

**é¢„æœŸç»“æœ**: âœ… æ‰€æœ‰åˆæ³•è½¬æ¢æˆåŠŸ

---

#### æµ‹è¯•ç”¨ä¾‹ 1.2.2: ç®¡ç†å‘˜éæ³•çŠ¶æ€è½¬æ¢è¢«æ‹’ç»
```sql
-- è®¾ç½®ç®¡ç†å‘˜ context
SET LOCAL role TO authenticated;
SET LOCAL request.jwt.claim.sub TO 'test-admin-uuid';

-- æµ‹è¯•å°è¯•ä¿®æ”¹é€€æ¬¾çŠ¶æ€ (åº”å¤±è´¥)
DO $$
BEGIN
  BEGIN
    UPDATE donations
    SET donation_status = 'refunded'  -- âŒ ç®¡ç†å‘˜ä¸èƒ½ä¿®æ”¹é€€æ¬¾çŠ¶æ€
    WHERE donation_public_id = 'TEST-PAID-002'
      AND donation_status = 'paid';

    RAISE EXCEPTION 'âš ï¸ Test failed: admin was able to set refunded status';
  EXCEPTION
    WHEN others THEN
      RAISE NOTICE 'âœ“ Admin correctly prevented from setting refund status: %', SQLERRM;
  END;
END $$;

RESET role;
```

**é¢„æœŸç»“æœ**: âœ… æŠ›å‡ºå¼‚å¸¸,é˜»æ­¢éæ³•è½¬æ¢

---

#### æµ‹è¯•ç”¨ä¾‹ 1.2.3: æœåŠ¡è§’è‰²ä¸å—é™åˆ¶
```sql
-- ä½¿ç”¨æœåŠ¡è§’è‰² (æ—  auth context)
-- auth.uid() è¿”å› NULL

-- æµ‹è¯•ä»»æ„çŠ¶æ€è½¬æ¢
UPDATE donations
SET donation_status = 'paid'
WHERE donation_public_id = 'TEST-PENDING-003'
  AND donation_status = 'pending';
-- âœ… åº”è¯¥æˆåŠŸ

UPDATE donations
SET donation_status = 'refunded'
WHERE donation_public_id = 'TEST-PAID-003'
  AND donation_status = 'paid';
-- âœ… åº”è¯¥æˆåŠŸ(æœåŠ¡è§’è‰²ä¸å—é™åˆ¶)
```

**é¢„æœŸç»“æœ**: âœ… æœåŠ¡è§’è‰²å¯ä»¥æ‰§è¡Œä»»æ„çŠ¶æ€è½¬æ¢

---

### 1.3 è¿½è¸ªå‡½æ•°æµ‹è¯•

#### æµ‹è¯•ç”¨ä¾‹ 1.3.1: éªŒè¯ order_reference è¿”å›
```sql
-- è°ƒç”¨è¿½è¸ªå‡½æ•°
SELECT
  donation_public_id,
  order_reference,  -- âœ¨ æ–°å¢å­—æ®µ
  donation_status
FROM get_donations_by_email_verified(
  'test@example.com',
  '1-A1B2C3'
);
```

**é¢„æœŸç»“æœ**: âœ… è¿”å›ç»“æœåŒ…å« `order_reference` å­—æ®µ

---

## 2. WayForPay é›†æˆæµ‹è¯•

### 2.1 Webhook çŠ¶æ€æ˜ å°„æµ‹è¯•

#### æµ‹è¯•ç”¨ä¾‹ 2.1.1: Approved çŠ¶æ€
```bash
# æ¨¡æ‹Ÿ WayForPay å‘é€ Approved webhook
curl -X POST http://localhost:3000/api/webhooks/wayforpay \
  -H "Content-Type: application/json" \
  -d '{
    "merchantAccount": "test_merchant",
    "orderReference": "DONATE-1-1234567890-TEST01",
    "amount": "100.00",
    "currency": "USD",
    "authCode": "123456",
    "cardPan": "4***1111",
    "transactionStatus": "Approved",
    "reasonCode": "1100",
    "merchantSignature": "<calculated_signature>"
  }'
```

**éªŒè¯æ­¥éª¤**:
1. æ£€æŸ¥æ•°æ®åº“: `donation_status` åº”ä¸º `paid`
2. æ£€æŸ¥é‚®ä»¶: åº”æ”¶åˆ°ç¡®è®¤é‚®ä»¶
3. æ£€æŸ¥æ—¥å¿—: `[WEBHOOK] Payment approved - funds received`

**é¢„æœŸç»“æœ**: âœ… çŠ¶æ€æ›´æ–°ä¸º `paid`, é‚®ä»¶å·²å‘é€

---

#### æµ‹è¯•ç”¨ä¾‹ 2.1.2: Pending (åæ¬ºè¯ˆå®¡æ ¸)
```bash
curl -X POST http://localhost:3000/api/webhooks/wayforpay \
  -d '{
    "transactionStatus": "Pending",
    "orderReference": "DONATE-1-1234567890-TEST02",
    ...
  }'
```

**é¢„æœŸç»“æœ**: âœ… çŠ¶æ€æ›´æ–°ä¸º `fraud_check`

---

#### æµ‹è¯•ç”¨ä¾‹ 2.1.3: Declined (æ”¯ä»˜è¢«æ‹’ç»)
```bash
curl -X POST http://localhost:3000/api/webhooks/wayforpay \
  -d '{
    "transactionStatus": "Declined",
    "orderReference": "DONATE-1-1234567890-TEST03",
    ...
  }'
```

**éªŒè¯æ­¥éª¤**:
1. ç¡®è®¤æèµ å½“å‰çŠ¶æ€ä¸º `pending`
2. å‘é€ Webhook
3. æ£€æŸ¥çŠ¶æ€åº”ä¸º `declined`

**é¢„æœŸç»“æœ**: âœ… pending â†’ declined

---

#### æµ‹è¯•ç”¨ä¾‹ 2.1.4: Declined (é€€æ¬¾è¢«æ‹’ç»)
```bash
# 1. å…ˆåˆ›å»º paid çŠ¶æ€æèµ 
# 2. ç”¨æˆ·ç”³è¯·é€€æ¬¾ â†’ refund_processing
# 3. å‘é€ Declined webhook

curl -X POST http://localhost:3000/api/webhooks/wayforpay \
  -d '{
    "transactionStatus": "Declined",
    "orderReference": "DONATE-1-1234567890-TEST04",
    ...
  }'
```

**éªŒè¯æ­¥éª¤**:
1. æèµ å½“å‰çŠ¶æ€ä¸º `refund_processing` æˆ– `paid`/`confirmed`/`delivering`
2. å‘é€ Webhook
3. æ£€æŸ¥çŠ¶æ€åº”ä¿æŒä¸å˜(ä¸æ˜¯ `declined`)

**é¢„æœŸç»“æœ**: âœ… é€€æ¬¾è¢«æ‹’ç»,ä¿æŒåŸçŠ¶æ€

---

#### æµ‹è¯•ç”¨ä¾‹ 2.1.5: Refunded å’Œ Voided ç»Ÿä¸€å¤„ç†
```bash
# æµ‹è¯• Refunded
curl -X POST http://localhost:3000/api/webhooks/wayforpay \
  -d '{
    "transactionStatus": "Refunded",
    "orderReference": "DONATE-1-1234567890-TEST05",
    ...
  }'

# æµ‹è¯• Voided
curl -X POST http://localhost:3000/api/webhooks/wayforpay \
  -d '{
    "transactionStatus": "Voided",
    "orderReference": "DONATE-1-1234567890-TEST06",
    ...
  }'
```

**é¢„æœŸç»“æœ**: âœ… ä¸¤ç§çŠ¶æ€éƒ½æ›´æ–°ä¸º `refunded`

---

### 2.2 ç­¾åéªŒè¯æµ‹è¯•

#### æµ‹è¯•ç”¨ä¾‹ 2.2.1: æ­£ç¡®ç­¾å
```typescript
// æµ‹è¯•æ­£ç¡®çš„ç­¾åè®¡ç®—
const testData = {
  merchantAccount: 'test_merchant',
  orderReference: 'TEST-001',
  amount: '100.00',
  currency: 'USD',
  authCode: '123456',
  cardPan: '4***1111',
  transactionStatus: 'Approved',
  reasonCode: '1100',
}

const signature = generateSignature([
  testData.merchantAccount,
  testData.orderReference,
  testData.amount,
  testData.currency,
  testData.authCode,
  testData.cardPan,
  testData.transactionStatus,
  testData.reasonCode,
])

const isValid = verifyWayForPaySignature(testData, signature)
console.assert(isValid === true, 'Signature verification failed')
```

**é¢„æœŸç»“æœ**: âœ… ç­¾åéªŒè¯é€šè¿‡

---

#### æµ‹è¯•ç”¨ä¾‹ 2.2.2: é”™è¯¯ç­¾åè¢«æ‹’ç»
```bash
curl -X POST http://localhost:3000/api/webhooks/wayforpay \
  -d '{
    "merchantAccount": "test_merchant",
    "orderReference": "TEST-002",
    "merchantSignature": "invalid_signature_here"
  }'
```

**é¢„æœŸç»“æœ**: âœ… è¿”å› 400 é”™è¯¯,æ—¥å¿—: `[WEBHOOK] Invalid signature`

---

### 2.3 é€€æ¬¾ API æµ‹è¯•

#### æµ‹è¯•ç”¨ä¾‹ 2.3.1: æˆåŠŸé€€æ¬¾
```typescript
// è°ƒç”¨é€€æ¬¾ API
const result = await processWayForPayRefund({
  orderReference: 'DONATE-1-1234567890-TEST07',
  amount: 100,
  currency: 'USD',
  comment: 'User requested refund',
})

console.log(result)
// é¢„æœŸ: { transactionStatus: 'RefundInProcessing' æˆ– 'Refunded', ... }
```

**éªŒè¯æ­¥éª¤**:
1. æ£€æŸ¥è¿”å›çš„ `transactionStatus`
2. éªŒè¯ç­¾å(å¦‚æœæœ‰ `merchantSignature`)
3. æ£€æŸ¥æ•°æ®åº“çŠ¶æ€æ˜¯å¦æ›´æ–°

**é¢„æœŸç»“æœ**: âœ… è¿”å›æˆåŠŸå“åº”,çŠ¶æ€æ›´æ–°ä¸º `refund_processing` æˆ– `refunded`

---

#### æµ‹è¯•ç”¨ä¾‹ 2.3.2: é€€æ¬¾è¢«æ‹’ç»
```typescript
const result = await processWayForPayRefund({
  orderReference: 'DONATE-1-1234567890-COMPLETED',  // å·²å®Œæˆçš„è®¢å•
  amount: 100,
  currency: 'USD',
  comment: 'Test refund decline',
})

console.log(result)
// é¢„æœŸ: { transactionStatus: 'Declined', reason: '...' }
```

**é¢„æœŸç»“æœ**: âœ… è¿”å› Declined å“åº”

---

## 3. å‰ç«¯é”™è¯¯å¤„ç†æµ‹è¯•

### 3.1 è„šæœ¬åŠ è½½å¤±è´¥

#### æµ‹è¯•ç”¨ä¾‹ 3.1.1: ç½‘ç»œæ–­å¼€
**æ­¥éª¤**:
1. æ‰“å¼€æèµ é¡µé¢
2. å¡«å†™è¡¨å•
3. æ–­å¼€ç½‘ç»œ
4. ç‚¹å‡»æäº¤

**é¢„æœŸç»“æœ**:
- âŒ æ˜¾ç¤ºé”™è¯¯: "Failed to load payment window"
- âŒ æ•°æ®åº“çŠ¶æ€: `widget_load_failed`
- âŒ è®¢å•å·æ˜¾ç¤º,æç¤ºè”ç³»å®¢æœ

---

#### æµ‹è¯•ç”¨ä¾‹ 3.1.2: WayForPay CDN æ•…éšœ
**æ­¥éª¤**:
1. ä½¿ç”¨æµè§ˆå™¨å¼€å‘å·¥å…·æ‹¦æˆª `https://secure.wayforpay.com/server/pay-widget.js`
2. è¿”å› 404 é”™è¯¯
3. æäº¤æèµ è¡¨å•

**é¢„æœŸç»“æœ**:
- âŒ 15ç§’åæ˜¾ç¤ºè¶…æ—¶é”™è¯¯
- âŒ æ•°æ®åº“çŠ¶æ€: `widget_load_failed`

---

### 3.2 ç”¨æˆ·å–æ¶ˆæ”¯ä»˜

#### æµ‹è¯•ç”¨ä¾‹ 3.2.1: å…³é—­æ”¯ä»˜çª—å£
**æ­¥éª¤**:
1. æäº¤æèµ è¡¨å•
2. æ”¯ä»˜çª—å£å¼¹å‡º
3. ç«‹å³å…³é—­çª—å£(ä¸è¾“å…¥ä»»ä½•ä¿¡æ¯)

**é¢„æœŸç»“æœ**:
- âŒ æ˜¾ç¤ºé”™è¯¯: "Payment window was closed"
- âŒ æ•°æ®åº“çŠ¶æ€: `user_cancelled`
- âœ… å¯ä»¥ç‚¹å‡»"Back to Edit"é‡æ–°æäº¤

---

#### æµ‹è¯•ç”¨ä¾‹ 3.2.2: ç‚¹å‡»è¿”å›æŒ‰é’®
**æ­¥éª¤**:
1. è¿›å…¥ WayForPay æ”¯ä»˜é¡µé¢
2. è¾“å…¥éƒ¨åˆ†ä¿¡æ¯
3. ç‚¹å‡»æµè§ˆå™¨è¿”å›æŒ‰é’®

**é¢„æœŸç»“æœ**:
- âŒ Pending callback è§¦å‘
- âŒ å¦‚æœ `response.orderReference` å­˜åœ¨,é‡å®šå‘æˆåŠŸé¡µ
- âŒ å¦‚æœä¸å­˜åœ¨,æ˜¾ç¤º"çª—å£å·²å…³é—­"

---

### 3.3 iOS è®¾å¤‡æµ‹è¯•

#### æµ‹è¯•ç”¨ä¾‹ 3.3.1: iOS Safari æ”¯ä»˜æµç¨‹
**æ­¥éª¤**:
1. ä½¿ç”¨ iPhone/iPad è®¿é—®æèµ é¡µé¢
2. æäº¤è¡¨å•
3. è§‚å¯Ÿé‡å®šå‘æç¤º

**é¢„æœŸç»“æœ**:
- âœ… æ˜¾ç¤º"Redirecting to Payment Page..."æç¤º
- âœ… 10ç§’å†…è‡ªåŠ¨è·³è½¬
- âœ… å¦‚æœ10ç§’åæœªè·³è½¬,æ˜¾ç¤º"å¼¹çª—è¢«æ‹¦æˆª"æç¤º

---

## 4. é€€æ¬¾æµç¨‹æµ‹è¯•

### 4.1 å®Œæ•´é€€æ¬¾æµç¨‹

#### æµ‹è¯•ç”¨ä¾‹ 4.1.1: æˆåŠŸé€€æ¬¾
**æ­¥éª¤**:
1. åˆ›å»ºå·²æ”¯ä»˜è®¢å•(2ä¸ªå•ä½)
2. è®¿é—®è¿½è¸ªé¡µé¢,è¾“å…¥é‚®ç®±å’Œæèµ ID
3. ç‚¹å‡»"ç”³è¯·é€€æ¬¾"
4. ç¡®è®¤é€€æ¬¾å¯¹è¯æ¡†

**éªŒè¯ç‚¹**:
- âœ… é€€æ¬¾è¯·æ±‚å‘é€æˆåŠŸ
- âœ… æ•°æ®åº“: è®¢å•ä¸­æ‰€æœ‰æèµ çŠ¶æ€æ›´æ–°ä¸º `refund_processing` æˆ– `refunded`
- âœ… UI: æ˜¾ç¤ºæ–°çŠ¶æ€å¾½ç« 
- âœ… é€€æ¬¾é‡‘é¢ = è®¢å•æ€»é‡‘é¢(ä¸æ˜¯å•ä¸ªæèµ )
- âœ… API è°ƒç”¨: `processWayForPayRefund` ä¼ å…¥æ­£ç¡®é‡‘é¢

**é¢„æœŸç»“æœ**: âœ… é€€æ¬¾æˆåŠŸ,çŠ¶æ€æ›´æ–°

---

#### æµ‹è¯•ç”¨ä¾‹ 4.1.2: é€€æ¬¾è¢«æ‹’ç»
**æ­¥éª¤**:
1. åˆ›å»ºæµ‹è¯•è®¢å•
2. æ¨¡æ‹Ÿ WayForPay API è¿”å› Declined
3. ç”³è¯·é€€æ¬¾

**é¢„æœŸç»“æœ**:
- âŒ æ˜¾ç¤ºé”™è¯¯: "Refund was declined by the payment provider"
- âœ… æ•°æ®åº“çŠ¶æ€ä¿æŒä¸å˜
- âœ… æç¤ºè”ç³»å®¢æœ

---

### 4.2 é€€æ¬¾èµ„æ ¼éªŒè¯

#### æµ‹è¯•ç”¨ä¾‹ 4.2.1: completed çŠ¶æ€ä¸å¯é€€æ¬¾
```typescript
// å‡†å¤‡æ•°æ®
const donation = {
  donation_public_id: 'COMPLETED-001',
  donation_status: 'completed',
  donor_email: 'test@example.com'
}

// å°è¯•é€€æ¬¾
const result = await requestRefund({
  donationPublicId: 'COMPLETED-001',
  email: 'test@example.com'
})

console.log(result)
// é¢„æœŸ: { error: 'cannotRefundCompleted' }
```

**é¢„æœŸç»“æœ**: âœ… è¿”å› `cannotRefundCompleted` é”™è¯¯

---

#### æµ‹è¯•ç”¨ä¾‹ 4.2.2: pending çŠ¶æ€ä¸å¯é€€æ¬¾
```typescript
const result = await requestRefund({
  donationPublicId: 'PENDING-001',
  email: 'test@example.com'
})

// é¢„æœŸ: { error: 'cannotRefundPending' }
```

**é¢„æœŸç»“æœ**: âœ… è¿”å› `cannotRefundPending` é”™è¯¯

---

#### æµ‹è¯•ç”¨ä¾‹ 4.2.3: å·²é€€æ¬¾è®¢å•ä¸å¯å†æ¬¡é€€æ¬¾
```typescript
const result = await requestRefund({
  donationPublicId: 'REFUNDED-001',
  email: 'test@example.com'
})

// é¢„æœŸ: { error: 'alreadyRefunding' }
```

**é¢„æœŸç»“æœ**: âœ… è¿”å› `alreadyRefunding` é”™è¯¯

---

### 4.3 è®¢å•æ•´ä½“é€€æ¬¾

#### æµ‹è¯•ç”¨ä¾‹ 4.3.1: å¤šå•ä½è®¢å•é€€æ¬¾
**å‡†å¤‡æ•°æ®**:
```sql
-- åˆ›å»ºåŒ…å«3ä¸ªæèµ çš„è®¢å•
INSERT INTO donations (order_reference, amount, donation_status, ...)
VALUES
  ('ORDER-001', 100, 'paid', ...),  -- æèµ 1
  ('ORDER-001', 100, 'paid', ...),  -- æèµ 2
  ('ORDER-001', 100, 'paid', ...);  -- æèµ 3
```

**æ­¥éª¤**:
1. ä½¿ç”¨ä»»æ„æèµ IDç”³è¯·é€€æ¬¾
2. æ£€æŸ¥ WayForPay API è°ƒç”¨å‚æ•°

**éªŒè¯ç‚¹**:
- âœ… API è°ƒç”¨ amount = 300 (3ä¸ªå•ä½æ€»å’Œ)
- âœ… æ‰€æœ‰3ä¸ªæèµ çŠ¶æ€åŒæ—¶æ›´æ–°
- âœ… UI æ˜¾ç¤º: "é€€æ¬¾å½±å“ 3 ä¸ªæèµ ,æ€»é‡‘é¢ 300 USD"

**é¢„æœŸç»“æœ**: âœ… æ•´ä¸ªè®¢å•é€€æ¬¾,ä¸æ˜¯å•ä¸ªæèµ 

---

#### æµ‹è¯•ç”¨ä¾‹ 4.3.2: è®¢å•ä¸­éƒ¨åˆ†æèµ å·²é€€æ¬¾
**å‡†å¤‡æ•°æ®**:
```sql
-- è®¢å•ä¸­æœ‰å·²é€€æ¬¾çš„æèµ 
INSERT INTO donations (order_reference, amount, donation_status, ...)
VALUES
  ('ORDER-002', 100, 'refunded', ...),  -- å·²é€€æ¬¾
  ('ORDER-002', 100, 'paid', ...);      -- æœªé€€æ¬¾
```

**æ­¥éª¤**:
1. å°è¯•å¯¹ paid çŠ¶æ€çš„æèµ ç”³è¯·é€€æ¬¾

**é¢„æœŸç»“æœ**: âœ… æ£€æµ‹åˆ°è®¢å•ä¸­æœ‰ `refunded` çŠ¶æ€,è¿”å› `alreadyRefunding` é”™è¯¯

---

## 5. ç®¡ç†å‘˜åŠŸèƒ½æµ‹è¯•

### 5.1 çŠ¶æ€æ›´æ–°

#### æµ‹è¯•ç”¨ä¾‹ 5.1.1: æ­£å¸¸ä¸šåŠ¡æµç¨‹
**æ­¥éª¤**:
1. ç®¡ç†å‘˜ç™»å½•
2. è®¿é—®æèµ ç®¡ç†é¡µé¢
3. é€‰æ‹© `paid` çŠ¶æ€æèµ 
4. ç‚¹å‡»ç¼–è¾‘
5. é€‰æ‹© `confirmed` çŠ¶æ€
6. ç‚¹å‡»æ›´æ–°

**é¢„æœŸç»“æœ**:
- âœ… çŠ¶æ€æ›´æ–°æˆåŠŸ
- âœ… æ•°æ®åº“: `paid` â†’ `confirmed`
- âœ… UI åˆ·æ–°æ˜¾ç¤ºæ–°çŠ¶æ€

**é‡å¤æµ‹è¯•**:
- `confirmed` â†’ `delivering`
- `delivering` â†’ `completed` (éœ€ä¸Šä¼ æ–‡ä»¶)

---

#### æµ‹è¯•ç”¨ä¾‹ 5.1.2: éæ³•çŠ¶æ€è½¬æ¢è¢«é˜»æ­¢
**æ­¥éª¤**:
1. å°è¯•å°† `paid` ç›´æ¥æ›´æ–°ä¸º `completed` (è·³è¿‡ä¸­é—´çŠ¶æ€)

**é¢„æœŸç»“æœ**:
- âŒ Server Action æŠ›å‡ºé”™è¯¯
- âŒ æ•°æ®åº“è§¦å‘å™¨ä¹Ÿé˜»æ­¢
- âŒ UI æ˜¾ç¤ºé”™è¯¯: "Invalid status transition"

---

#### æµ‹è¯•ç”¨ä¾‹ 5.1.3: ç®¡ç†å‘˜æ— æ³•ä¿®æ”¹é€€æ¬¾çŠ¶æ€
**æ­¥éª¤**:
1. å°è¯•å°† `paid` æ›´æ–°ä¸º `refunded`

**é¢„æœŸç»“æœ**:
- âŒ Server Action æŠ›å‡ºé”™è¯¯: "Refund statuses are handled automatically"
- âŒ æ•°æ®åº“è§¦å‘å™¨é˜»æ­¢
- âŒ UI ä¸æ˜¾ç¤ºé€€æ¬¾çŠ¶æ€é€‰é¡¹

---

### 5.2 æ–‡ä»¶ä¸Šä¼ 

#### æµ‹è¯•ç”¨ä¾‹ 5.2.1: delivering â†’ completed éœ€è¦æ–‡ä»¶
**æ­¥éª¤**:
1. é€‰æ‹© `delivering` çŠ¶æ€æèµ 
2. ç‚¹å‡»ç¼–è¾‘
3. é€‰æ‹© `completed` çŠ¶æ€
4. ä¸ä¸Šä¼ æ–‡ä»¶
5. ç‚¹å‡»æ›´æ–°

**é¢„æœŸç»“æœ**:
- âŒ æ˜¾ç¤ºé”™è¯¯: "Please upload at least one result image/video"
- âŒ çŠ¶æ€ä¸æ›´æ–°

---

#### æµ‹è¯•ç”¨ä¾‹ 5.2.2: ä¸Šä¼ æ–‡ä»¶æˆåŠŸ
**æ­¥éª¤**:
1. é€‰æ‹© `delivering` çŠ¶æ€æèµ 
2. ç‚¹å‡»ç¼–è¾‘
3. é€‰æ‹© `completed` çŠ¶æ€
4. ä¸Šä¼ å›¾ç‰‡(JPEG, 2MB)
5. ç‚¹å‡»æ›´æ–°

**éªŒè¯ç‚¹**:
- âœ… æ˜¾ç¤ºä¸Šä¼ è¿›åº¦æ¡
- âœ… æ–‡ä»¶ä¸Šä¼ åˆ° `donation-results/{donation_public_id}/`
- âœ… è‡ªåŠ¨ç”Ÿæˆç¼©ç•¥å›¾(å¦‚æœæ˜¯å›¾ç‰‡)
- âœ… çŠ¶æ€æ›´æ–°ä¸º `completed`
- âœ… æ–‡ä»¶å¯åœ¨ç¼–è¾‘æ¨¡æ€æ¡†ä¸­é¢„è§ˆ

**é¢„æœŸç»“æœ**: âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ,çŠ¶æ€æ›´æ–°

---

#### æµ‹è¯•ç”¨ä¾‹ 5.2.3: æ–‡ä»¶ç±»å‹éªŒè¯
**æ­¥éª¤**:
1. å°è¯•ä¸Šä¼  PDF æ–‡ä»¶

**é¢„æœŸç»“æœ**:
- âŒ æ˜¾ç¤ºé”™è¯¯: "Invalid file type. Only images (JPEG, PNG, GIF) and videos (MP4, MOV) are allowed."

---

#### æµ‹è¯•ç”¨ä¾‹ 5.2.4: æ–‡ä»¶å¤§å°é™åˆ¶
**æ­¥éª¤**:
1. å°è¯•ä¸Šä¼  60MB è§†é¢‘

**é¢„æœŸç»“æœ**:
- âŒ æ˜¾ç¤ºé”™è¯¯: "File too large (max 50MB)"

---

#### æµ‹è¯•ç”¨ä¾‹ 5.2.5: å¤šæ–‡ä»¶ä¸Šä¼ 
**æ­¥éª¤**:
1. é€‰æ‹©3å¼ å›¾ç‰‡(å…±5MB)
2. ä¸Šä¼ 

**éªŒè¯ç‚¹**:
- âœ… æ˜¾ç¤º: "3 file(s) selected"
- âœ… æ¯ä¸ªæ–‡ä»¶å•ç‹¬ä¸Šä¼ 
- âœ… è¿›åº¦æ¡æ˜¾ç¤º: 33% â†’ 66% â†’ 100%
- âœ… æ‰€æœ‰æ–‡ä»¶éƒ½èƒ½é¢„è§ˆ

**é¢„æœŸç»“æœ**: âœ… å¤šæ–‡ä»¶ä¸Šä¼ æˆåŠŸ

---

### 5.3 completed çŠ¶æ€æ–‡ä»¶ç®¡ç†

#### æµ‹è¯•ç”¨ä¾‹ 5.3.1: æŸ¥çœ‹å·²ä¸Šä¼ æ–‡ä»¶
**æ­¥éª¤**:
1. é€‰æ‹© `completed` çŠ¶æ€æèµ 
2. ç‚¹å‡»ç¼–è¾‘

**é¢„æœŸç»“æœ**:
- âœ… æ˜¾ç¤º"Result Files Management"éƒ¨åˆ†
- âœ… åˆ—å‡ºæ‰€æœ‰å·²ä¸Šä¼ æ–‡ä»¶
- âœ… å›¾ç‰‡æ˜¾ç¤ºç¼©ç•¥å›¾é¢„è§ˆ
- âœ… è§†é¢‘æ˜¾ç¤ºæ’­æ”¾å™¨
- âœ… æ˜¾ç¤ºæ–‡ä»¶å¤§å°å’Œä¸Šä¼ æ—¶é—´

---

#### æµ‹è¯•ç”¨ä¾‹ 5.3.2: åˆ é™¤æ–‡ä»¶
**æ­¥éª¤**:
1. ç‚¹å‡»æŸä¸ªæ–‡ä»¶çš„"Delete"æŒ‰é’®
2. ç¡®è®¤åˆ é™¤

**é¢„æœŸç»“æœ**:
- âœ… æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†: "ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—?"
- âœ… æ–‡ä»¶ä»åˆ—è¡¨ä¸­æ¶ˆå¤±
- âœ… Storage ä¸­æ–‡ä»¶è¢«åˆ é™¤
- âœ… ç¼©ç•¥å›¾(å¦‚æœæœ‰)ä¹Ÿè¢«åˆ é™¤

---

#### æµ‹è¯•ç”¨ä¾‹ 5.3.3: completed çŠ¶æ€ä¸Šä¼ æ–°æ–‡ä»¶
**æ­¥éª¤**:
1. åœ¨"Upload New Files"éƒ¨åˆ†é€‰æ‹©æ–‡ä»¶
2. ç‚¹å‡»"Upload"

**é¢„æœŸç»“æœ**:
- âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ
- âœ… æ–°æ–‡ä»¶å‡ºç°åœ¨åˆ—è¡¨ä¸­
- âœ… çŠ¶æ€ä¿æŒ `completed`(ä¸éœ€è¦æ›´æ–°çŠ¶æ€)

---

## 6. UI ç»„ä»¶æµ‹è¯•

### 6.1 DonationStatusBadge

#### æµ‹è¯•ç”¨ä¾‹ 6.1.1: æ‰€æœ‰çŠ¶æ€æ˜¾ç¤ºæ­£ç¡®
```tsx
// æµ‹è¯•æ‰€æœ‰16ä¸ªçŠ¶æ€
const statuses: DonationStatus[] = [
  'pending', 'widget_load_failed', 'user_cancelled',
  'processing', 'fraud_check',
  'paid', 'confirmed', 'delivering', 'completed',
  'expired', 'declined', 'failed',
  'refunding', 'refund_processing', 'refunded'
]

statuses.forEach(status => {
  render(<DonationStatusBadge status={status} />)
  // éªŒè¯é¢œè‰²å’Œæ–‡æœ¬
})
```

**éªŒè¯ç‚¹**:
- âœ… pending: é»„è‰²èƒŒæ™¯
- âœ… paid/confirmed/completed: ç»¿è‰²èƒŒæ™¯
- âœ… failed/declined: çº¢è‰²èƒŒæ™¯
- âœ… refunding: æ©™è‰²èƒŒæ™¯
- âœ… æ–‡æœ¬ä½¿ç”¨æ­£ç¡®çš„ç¿»è¯‘é”®

---

#### æµ‹è¯•ç”¨ä¾‹ 6.1.2: å¤šè¯­è¨€æ”¯æŒ
```tsx
// æµ‹è¯• en/zh/ua ä¸‰ç§è¯­è¨€
<DonationStatusBadge status="paid" namespace="trackDonation" />
// è‹±æ–‡: "Payment Received"
// ä¸­æ–‡: "å·²æ”¯ä»˜"
// ä¹Œå…‹å…°è¯­: "ĞĞ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ¾"
```

**é¢„æœŸç»“æœ**: âœ… æ˜¾ç¤ºæ­£ç¡®çš„ç¿»è¯‘

---

### 6.2 è®¢å•åˆ†ç»„å¡ç‰‡

#### æµ‹è¯•ç”¨ä¾‹ 6.2.1: å•é¡¹ç›®è®¢å•
**å‡†å¤‡æ•°æ®**:
```
è®¢å•: ORDER-001
  æèµ 1: é¡¹ç›®A, $100, paid
  æèµ 2: é¡¹ç›®A, $100, paid
```

**é¢„æœŸæ˜¾ç¤º**:
```
è®¢å• #ORDER-001
è®¢å•å·: ORDER-001
æ•°é‡: 2 units
æ€»é‡‘é¢: USD 200.00
æ—¥æœŸ: 2025-12-24

æèµ :
  - 1-A1B2C3 [å·²æ”¯ä»˜] é¡¹ç›®A  USD 100.00
  - 1-A1B2C4 [å·²æ”¯ä»˜] é¡¹ç›®A  USD 100.00

[ç”³è¯·é€€æ¬¾]
```

---

#### æµ‹è¯•ç”¨ä¾‹ 6.2.2: å¤šé¡¹ç›®è®¢å•
**å‡†å¤‡æ•°æ®**:
```
è®¢å•: ORDER-002
  æèµ 1: é¡¹ç›®A, $100, paid
  æèµ 2: é¡¹ç›®B, $150, paid
```

**é¢„æœŸæ˜¾ç¤º**:
```
è®¢å• #ORDER-002
2 projects in this order
è®¢å•å·: ORDER-002
æ•°é‡: 2 units
æ€»é‡‘é¢: USD 250.00

æèµ :
  - 1-A1B2C3 [å·²æ”¯ä»˜] é¡¹ç›®A  USD 100.00
  - 2-B1C2D3 [å·²æ”¯ä»˜] é¡¹ç›®B  USD 150.00
```

---

#### æµ‹è¯•ç”¨ä¾‹ 6.2.3: éƒ¨åˆ†é€€æ¬¾è®¢å•
**å‡†å¤‡æ•°æ®**:
```
è®¢å•: ORDER-003
  æèµ 1: é¡¹ç›®A, $100, refunded
  æèµ 2: é¡¹ç›®A, $100, paid
```

**é¢„æœŸæ˜¾ç¤º**:
```
æ€»é‡‘é¢: USD 100.00  (åªç»Ÿè®¡ paid,ä¸ç»Ÿè®¡ refunded)
å¯é€€æ¬¾é‡‘é¢: USD 100.00

[ç”³è¯·é€€æ¬¾]  (æŒ‰é’®å­˜åœ¨,å› ä¸º refundableAmount > 0)
```

---

#### æµ‹è¯•ç”¨ä¾‹ 6.2.4: completed è®¢å•æ˜¾ç¤ºæŸ¥çœ‹ç»“æœ
**å‡†å¤‡æ•°æ®**:
```
è®¢å•: ORDER-004
  æèµ 1: é¡¹ç›®A, $100, completed
```

**é¢„æœŸæ˜¾ç¤º**:
```
[æŸ¥çœ‹ç»“æœ]  (æŒ‰é’®å­˜åœ¨)
[ç”³è¯·é€€æ¬¾]  (æŒ‰é’®ä¸å­˜åœ¨,å› ä¸º refundableAmount = 0)
```

---

## 7. ç«¯åˆ°ç«¯æµ‹è¯•åœºæ™¯

### 7.1 å®Œæ•´æèµ æµç¨‹

#### åœºæ™¯ 7.1.1: æˆåŠŸæèµ å¹¶å®Œæˆé…é€
**æ­¥éª¤**:
1. **ç”¨æˆ·**: è®¿é—®ä¸»é¡µ,é€‰æ‹©é¡¹ç›®
2. **ç”¨æˆ·**: å¡«å†™æèµ è¡¨å•(2ä¸ªå•ä½)
3. **ç”¨æˆ·**: æäº¤è¡¨å•,WayForPay çª—å£å¼¹å‡º
4. **ç”¨æˆ·**: å®Œæˆæ”¯ä»˜(æµ‹è¯•å¡)
5. **ç³»ç»Ÿ**: Webhook æ”¶åˆ° Approved,çŠ¶æ€ â†’ `paid`,å‘é€é‚®ä»¶
6. **ç”¨æˆ·**: é‡å®šå‘åˆ°æˆåŠŸé¡µ,æ˜¾ç¤º2ä¸ªæèµ ID
7. **ç”¨æˆ·**: æ”¶åˆ°ç¡®è®¤é‚®ä»¶
8. **ç®¡ç†å‘˜**: ç™»å½•,æŸ¥çœ‹æ–°æèµ 
9. **ç®¡ç†å‘˜**: æ›´æ–°çŠ¶æ€ `paid` â†’ `confirmed`
10. **ç®¡ç†å‘˜**: æ›´æ–°çŠ¶æ€ `confirmed` â†’ `delivering`
11. **ç®¡ç†å‘˜**: é‡‡è´­ç‰©èµ„,é…é€
12. **ç®¡ç†å‘˜**: ä¸Šä¼ é…é€ç…§ç‰‡,æ›´æ–°çŠ¶æ€ `delivering` â†’ `completed`
13. **ç”¨æˆ·**: è®¿é—®è¿½è¸ªé¡µé¢,æŸ¥çœ‹ `completed` çŠ¶æ€
14. **ç”¨æˆ·**: ç‚¹å‡»"æŸ¥çœ‹ç»“æœ",æŸ¥çœ‹é…é€ç…§ç‰‡

**é¢„æœŸç»“æœ**: âœ… å®Œæ•´æµç¨‹æ— é”™è¯¯,ç”¨æˆ·ä½“éªŒæµç•…

---

#### åœºæ™¯ 7.1.2: æ”¯ä»˜å¤±è´¥å¤„ç†
**æ­¥éª¤**:
1. **ç”¨æˆ·**: æäº¤æèµ è¡¨å•
2. **ç”¨æˆ·**: ä½¿ç”¨æµ‹è¯•å¡(declined)
3. **ç³»ç»Ÿ**: Webhook æ”¶åˆ° Declined,çŠ¶æ€ â†’ `declined`
4. **ç”¨æˆ·**: é‡å®šå‘åˆ°æˆåŠŸé¡µ,ä½†æ— æèµ è¯¦æƒ…(å› ä¸ºçŠ¶æ€ä¸æ˜¯ paid)
5. **ç”¨æˆ·**: è®¿é—®è¿½è¸ªé¡µé¢,çœ‹åˆ° `declined` çŠ¶æ€
6. **ç”¨æˆ·**: é‡æ–°å‘èµ·æèµ (æ–°è®¢å•)

**é¢„æœŸç»“æœ**: âœ… å¤±è´¥è®¢å•æ­£ç¡®æ ‡è®°,ç”¨æˆ·å¯é‡è¯•

---

### 7.2 é€€æ¬¾æµç¨‹

#### åœºæ™¯ 7.2.1: ç”¨æˆ·ç”³è¯·é€€æ¬¾
**æ­¥éª¤**:
1. **å‡†å¤‡**: å·²æ”¯ä»˜è®¢å•(çŠ¶æ€ `paid`)
2. **ç”¨æˆ·**: è®¿é—®è¿½è¸ªé¡µé¢
3. **ç”¨æˆ·**: è¾“å…¥é‚®ç®±å’Œæèµ ID,æŸ¥è¯¢
4. **ç”¨æˆ·**: çœ‹åˆ°è®¢å•è¯¦æƒ…,çŠ¶æ€ `paid`
5. **ç”¨æˆ·**: ç‚¹å‡»"ç”³è¯·é€€æ¬¾"
6. **ç”¨æˆ·**: ç¡®è®¤å¯¹è¯æ¡†
7. **ç³»ç»Ÿ**: è°ƒç”¨ WayForPay Refund API
8. **ç³»ç»Ÿ**: æ›´æ–°æ‰€æœ‰æèµ çŠ¶æ€ â†’ `refund_processing`
9. **WayForPay**: å¤„ç†é€€æ¬¾,å‘é€ Webhook
10. **ç³»ç»Ÿ**: æ”¶åˆ° Refunded webhook,çŠ¶æ€ â†’ `refunded`
11. **ç”¨æˆ·**: åˆ·æ–°é¡µé¢,çœ‹åˆ° `refunded` çŠ¶æ€

**é¢„æœŸç»“æœ**: âœ… é€€æ¬¾æµç¨‹é¡ºåˆ©,çŠ¶æ€æ­£ç¡®æ›´æ–°

---

### 7.3 é”™è¯¯æ¢å¤åœºæ™¯

#### åœºæ™¯ 7.3.1: ç½‘ç»œä¸­æ–­åæ¢å¤
**æ­¥éª¤**:
1. **ç”¨æˆ·**: æäº¤æèµ è¡¨å•
2. **ç³»ç»Ÿ**: åˆ›å»º `pending` è®°å½•
3. **ç½‘ç»œ**: æ–­å¼€(è„šæœ¬åŠ è½½å¤±è´¥)
4. **ç³»ç»Ÿ**: 15ç§’åæ ‡è®° `widget_load_failed`
5. **ç”¨æˆ·**: çœ‹åˆ°é”™è¯¯æç¤º,ä¿å­˜è®¢å•å·
6. **ç½‘ç»œ**: æ¢å¤
7. **ç”¨æˆ·**: åˆ·æ–°é¡µé¢,é‡æ–°æäº¤(æ–°è®¢å•)
8. **ç³»ç»Ÿ**: æˆåŠŸå®Œæˆæ”¯ä»˜

**éªŒè¯ç‚¹**:
- âœ… ç¬¬ä¸€ä¸ªè®¢å•: `widget_load_failed`
- âœ… ç¬¬äºŒä¸ªè®¢å•: `paid`
- âœ… é¡¹ç›®è¿›åº¦åªç»Ÿè®¡ `paid` è®¢å•

**é¢„æœŸç»“æœ**: âœ… å¤±è´¥è®¢å•ä¸å½±å“åç»­æ“ä½œ

---

## 8. å›å½’æµ‹è¯•

### 8.1 åŸæœ‰åŠŸèƒ½ä¸å—å½±å“

#### æµ‹è¯•ç”¨ä¾‹ 8.1.1: é¡¹ç›®åˆ—è¡¨æ˜¾ç¤º
- âœ… ä¸»é¡µé¡¹ç›®å¡ç‰‡æ­£å¸¸æ˜¾ç¤º
- âœ… è¿›åº¦æ¡è®¡ç®—æ­£ç¡®(åªç»Ÿè®¡ paid åŠä»¥ä¸Š)
- âœ… é¡¹ç›®çŠ¶æ€(active/completed)æ­£ç¡®

---

#### æµ‹è¯•ç”¨ä¾‹ 8.1.2: æèµ è¡¨å•
- âœ… è¡¨å•éªŒè¯æ­£å¸¸å·¥ä½œ
- âœ… æ•°é‡é™åˆ¶æ£€æŸ¥
- âœ… é‚®ç®±éªŒè¯

---

#### æµ‹è¯•ç”¨ä¾‹ 8.1.3: é‚®ä»¶å‘é€
- âœ… æ”¯ä»˜æˆåŠŸåå‘é€ç¡®è®¤é‚®ä»¶
- âœ… é‚®ä»¶åŒ…å«æ­£ç¡®çš„æèµ ID
- âœ… å¤šè¯­è¨€é‚®ä»¶æ¨¡æ¿

---

## 9. æ€§èƒ½æµ‹è¯•

### 9.1 æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½

#### æµ‹è¯•ç”¨ä¾‹ 9.1.1: è¿½è¸ªæŸ¥è¯¢æ€§èƒ½
```sql
-- æµ‹è¯• 1000 ä¸ªè®¢å•,æ¯ä¸ªè®¢å•10ä¸ªæèµ 
EXPLAIN ANALYZE
SELECT * FROM get_donations_by_email_verified('test@example.com', '1-A1B2C3');
```

**é¢„æœŸç»“æœ**: âœ… æŸ¥è¯¢æ—¶é—´ < 100ms

---

#### æµ‹è¯•ç”¨ä¾‹ 9.1.2: ç®¡ç†å‘˜åˆ—è¡¨æŸ¥è¯¢
```sql
-- æµ‹è¯• 10000 æ¡æèµ è®°å½•
EXPLAIN ANALYZE
SELECT * FROM donations
WHERE donation_status IN ('paid', 'confirmed', 'delivering')
ORDER BY donated_at DESC
LIMIT 100;
```

**é¢„æœŸç»“æœ**:
- âœ… æŸ¥è¯¢æ—¶é—´ < 200ms
- âœ… ä½¿ç”¨ç´¢å¼•(donation_status, donated_at)

---

### 9.2 æ–‡ä»¶ä¸Šä¼ æ€§èƒ½

#### æµ‹è¯•ç”¨ä¾‹ 9.2.1: å¤§æ–‡ä»¶ä¸Šä¼ 
**æ­¥éª¤**:
1. ä¸Šä¼  50MB è§†é¢‘

**éªŒè¯ç‚¹**:
- âœ… ä¸Šä¼ æ—¶é—´ < 30ç§’(å–å†³äºç½‘ç»œ)
- âœ… è¿›åº¦æ¡å¹³æ»‘æ˜¾ç¤º
- âœ… æ— å†…å­˜æ³„æ¼

---

#### æµ‹è¯•ç”¨ä¾‹ 9.2.2: ç¼©ç•¥å›¾ç”Ÿæˆæ€§èƒ½
**æ­¥éª¤**:
1. ä¸Šä¼  10MB é«˜åˆ†è¾¨ç‡å›¾ç‰‡(5000x5000)

**éªŒè¯ç‚¹**:
- âœ… ç¼©ç•¥å›¾ç”Ÿæˆæ—¶é—´ < 3ç§’
- âœ… ç¼©ç•¥å›¾å¤§å° < 50KB
- âœ… ç¼©ç•¥å›¾è´¨é‡å¯æ¥å—

---

## 10. å®‰å…¨æµ‹è¯•

### 10.1 æƒé™æµ‹è¯•

#### æµ‹è¯•ç”¨ä¾‹ 10.1.1: åŒ¿åç”¨æˆ·æ— æ³•ä¿®æ”¹çŠ¶æ€
```bash
# å°è¯•ä½¿ç”¨ anon key æ›´æ–°çŠ¶æ€
curl -X PATCH https://your-project.supabase.co/rest/v1/donations?id=eq.1 \
  -H "apikey: <anon_key>" \
  -H "Content-Type: application/json" \
  -d '{"donation_status":"completed"}'
```

**é¢„æœŸç»“æœ**: âŒ 403 Forbidden (RLS é˜»æ­¢)

---

#### æµ‹è¯•ç”¨ä¾‹ 10.1.2: ç®¡ç†å‘˜åªèƒ½ä¿®æ”¹å…è®¸çš„çŠ¶æ€
```typescript
// å·²æµ‹è¯•äºæ•°æ®åº“å±‚æµ‹è¯• 1.2.2
```

---

### 10.2 è¾“å…¥éªŒè¯

#### æµ‹è¯•ç”¨ä¾‹ 10.2.1: SQL æ³¨å…¥é˜²æŠ¤
```typescript
// å°è¯•æ³¨å…¥
await trackDonations({
  email: "test@example.com'; DROP TABLE donations; --",
  donationId: '1-A1B2C3'
})
```

**é¢„æœŸç»“æœ**: âœ… å‚æ•°åŒ–æŸ¥è¯¢é˜²æ­¢æ³¨å…¥

---

#### æµ‹è¯•ç”¨ä¾‹ 10.2.2: XSS é˜²æŠ¤
```typescript
// å°è¯•æ³¨å…¥è„šæœ¬
await createDonation({
  donor_name: '<script>alert("XSS")</script>',
  donor_email: 'test@example.com',
  ...
})
```

**é¢„æœŸç»“æœ**: âœ… è¾“å…¥è¢«è½¬ä¹‰,ä¸ä¼šæ‰§è¡Œè„šæœ¬

---

### 10.3 ç­¾åä¼ªé€ é˜²æŠ¤

#### æµ‹è¯•ç”¨ä¾‹ 10.3.1: ä¼ªé€  Webhook
```bash
# å‘é€æ²¡æœ‰æ­£ç¡®ç­¾åçš„ Webhook
curl -X POST http://localhost:3000/api/webhooks/wayforpay \
  -d '{
    "transactionStatus": "Approved",
    "orderReference": "FAKE-ORDER",
    "merchantSignature": "fake_signature"
  }'
```

**é¢„æœŸç»“æœ**: âœ… è¿”å› 400 é”™è¯¯,æ—¥å¿—: "Invalid signature"

---

## ğŸ“Š æµ‹è¯•æ£€æŸ¥æ¸…å•

### æ•°æ®åº“å±‚ âœ…
- [ ] 16ä¸ªçŠ¶æ€éƒ½èƒ½æ’å…¥
- [ ] éæ³•çŠ¶æ€è¢«æ‹’ç»
- [ ] ç®¡ç†å‘˜åˆæ³•è½¬æ¢æˆåŠŸ
- [ ] ç®¡ç†å‘˜éæ³•è½¬æ¢è¢«é˜»æ­¢
- [ ] æœåŠ¡è§’è‰²ä¸å—é™åˆ¶
- [ ] è¿½è¸ªå‡½æ•°è¿”å› order_reference

### WayForPay é›†æˆ âœ…
- [ ] Approved â†’ paid + é‚®ä»¶
- [ ] Pending â†’ fraud_check
- [ ] Declined (æ”¯ä»˜) â†’ declined
- [ ] Declined (é€€æ¬¾) â†’ ä¿æŒåŸçŠ¶æ€
- [ ] Refunded/Voided â†’ refunded
- [ ] ç­¾åéªŒè¯æ­£ç¡®
- [ ] é€€æ¬¾ API è°ƒç”¨æˆåŠŸ

### å‰ç«¯é”™è¯¯å¤„ç† âœ…
- [ ] è„šæœ¬åŠ è½½å¤±è´¥ â†’ widget_load_failed
- [ ] ç”¨æˆ·å–æ¶ˆ â†’ user_cancelled
- [ ] iOS è®¾å¤‡é‡å®šå‘æç¤º

### é€€æ¬¾æµç¨‹ âœ…
- [ ] æˆåŠŸé€€æ¬¾
- [ ] é€€æ¬¾è¢«æ‹’ç»
- [ ] completed ä¸å¯é€€æ¬¾
- [ ] pending ä¸å¯é€€æ¬¾
- [ ] è®¢å•æ•´ä½“é€€æ¬¾
- [ ] éƒ¨åˆ†å·²é€€æ¬¾è®¢å•æ‹’ç»

### ç®¡ç†å‘˜åŠŸèƒ½ âœ…
- [ ] æ­£å¸¸ä¸šåŠ¡æµç¨‹
- [ ] éæ³•è½¬æ¢è¢«é˜»æ­¢
- [ ] æ— æ³•ä¿®æ”¹é€€æ¬¾çŠ¶æ€
- [ ] delivering â†’ completed éœ€è¦æ–‡ä»¶
- [ ] æ–‡ä»¶ä¸Šä¼ æˆåŠŸ
- [ ] æ–‡ä»¶ç±»å‹/å¤§å°éªŒè¯
- [ ] å¤šæ–‡ä»¶ä¸Šä¼ 
- [ ] completed æ–‡ä»¶ç®¡ç†

### UI ç»„ä»¶ âœ…
- [ ] çŠ¶æ€å¾½ç« é¢œè‰²æ­£ç¡®
- [ ] å¤šè¯­è¨€æ”¯æŒ
- [ ] è®¢å•åˆ†ç»„æ˜¾ç¤º
- [ ] å¤šé¡¹ç›®è®¢å•æç¤º
- [ ] é€€æ¬¾æŒ‰é’®æ˜¾ç¤ºé€»è¾‘

### ç«¯åˆ°ç«¯åœºæ™¯ âœ…
- [ ] å®Œæ•´æèµ æµç¨‹
- [ ] æ”¯ä»˜å¤±è´¥å¤„ç†
- [ ] é€€æ¬¾æµç¨‹
- [ ] é”™è¯¯æ¢å¤

### å›å½’æµ‹è¯• âœ…
- [ ] é¡¹ç›®åˆ—è¡¨
- [ ] æèµ è¡¨å•
- [ ] é‚®ä»¶å‘é€

### æ€§èƒ½æµ‹è¯• âœ…
- [ ] è¿½è¸ªæŸ¥è¯¢ < 100ms
- [ ] ç®¡ç†å‘˜åˆ—è¡¨ < 200ms
- [ ] å¤§æ–‡ä»¶ä¸Šä¼  < 30s
- [ ] ç¼©ç•¥å›¾ç”Ÿæˆ < 3s

### å®‰å…¨æµ‹è¯• âœ…
- [ ] RLS æƒé™æ§åˆ¶
- [ ] ç®¡ç†å‘˜æƒé™é™åˆ¶
- [ ] SQL æ³¨å…¥é˜²æŠ¤
- [ ] XSS é˜²æŠ¤
- [ ] ç­¾åéªŒè¯

---

## ğŸ”§ æµ‹è¯•ç¯å¢ƒé…ç½®

### å¼€å‘ç¯å¢ƒ
```bash
# .env.local
NEXT_PUBLIC_SUPABASE_URL=http://localhost:54321
NEXT_PUBLIC_SUPABASE_ANON_KEY=<test_anon_key>
SUPABASE_SERVICE_ROLE_KEY=<test_service_key>
WAYFORPAY_MERCHANT_ACCOUNT=test_merchant
WAYFORPAY_SECRET_KEY=test_secret
```

### æµ‹è¯•æ•°æ®å‡†å¤‡
```sql
-- åˆ›å»ºæµ‹è¯•é¡¹ç›®
INSERT INTO projects (project_name, target_units, unit_price, status)
VALUES ('Test Project', 100, 100, 'active');

-- åˆ›å»ºæµ‹è¯•æèµ (å„ç§çŠ¶æ€)
INSERT INTO donations (donation_public_id, project_id, donation_status, ...)
VALUES
  ('TEST-PENDING-001', 1, 'pending', ...),
  ('TEST-PAID-001', 1, 'paid', ...),
  ('TEST-CONFIRMED-001', 1, 'confirmed', ...),
  ('TEST-DELIVERING-001', 1, 'delivering', ...),
  ('TEST-COMPLETED-001', 1, 'completed', ...),
  ('TEST-REFUNDED-001', 1, 'refunded', ...);
```

---

## ğŸ“ æµ‹è¯•æŠ¥å‘Šæ¨¡æ¿

### æµ‹è¯•æ‰§è¡Œè®°å½•
| æµ‹è¯•ç”¨ä¾‹ ID | æµ‹è¯•åç§° | æ‰§è¡Œæ—¥æœŸ | æ‰§è¡Œäºº | ç»“æœ | å¤‡æ³¨ |
|------------|---------|---------|-------|------|------|
| 1.1.1 | åˆæ³•çŠ¶æ€æ’å…¥ | 2025-12-24 | Tester | âœ… PASS | - |
| 1.1.2 | éæ³•çŠ¶æ€æ‹’ç» | 2025-12-24 | Tester | âœ… PASS | - |
| 2.1.1 | Approved Webhook | 2025-12-24 | Tester | âŒ FAIL | é‚®ä»¶æœªå‘é€ |
| ... | ... | ... | ... | ... | ... |

### Bug æŠ¥å‘Šæ¨¡æ¿
```
Bug ID: BUG-001
ä¸¥é‡ç¨‹åº¦: High / Medium / Low
ä¼˜å…ˆçº§: P0 / P1 / P2
å‘ç°æ—¥æœŸ: 2025-12-24
å‘ç°è€…: Tester

æ ‡é¢˜: ç®€çŸ­æè¿°é—®é¢˜

å¤ç°æ­¥éª¤:
1. æ­¥éª¤1
2. æ­¥éª¤2
3. æ­¥éª¤3

é¢„æœŸç»“æœ: åº”è¯¥å‘ç”Ÿä»€ä¹ˆ

å®é™…ç»“æœ: å®é™…å‘ç”Ÿäº†ä»€ä¹ˆ

ç¯å¢ƒ: Development / Staging / Production
æµè§ˆå™¨: Chrome 120 / Safari 17 / ...

æˆªå›¾/æ—¥å¿—: [é™„ä»¶]

å»ºè®®ä¿®å¤: (å¯é€‰)
```

---

**æµ‹è¯•è´Ÿè´£äºº**: QA Team
**æµ‹è¯•å‘¨æœŸ**: 2025-12-24 - 2025-12-26
**è¦†ç›–ç‡ç›®æ ‡**: 90%+

---

**å‚è€ƒæ–‡æ¡£**:
- [CODE_REVIEW_2025-12-24.md](./CODE_REVIEW_2025-12-24.md)
- [PAYMENT_WORKFLOW.md](./PAYMENT_WORKFLOW.md)
- [DATABASE_SCHEMA.md](./DATABASE_SCHEMA.md)
