# NGO å¹³å° - é¡¹ç›®æŠ€æœ¯æ–‡æ¡£

> ä¸€ä¸ªç°ä»£åŒ–çš„éæ”¿åºœç»„ç»‡(NGO)æèµ å¹³å°ï¼Œæ”¯æŒå¤šè¯­è¨€ã€åœ¨çº¿æ”¯ä»˜å’Œæèµ è¿½è¸ª

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
3. [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
4. [æ•°æ®åº“æ¶æ„](#æ•°æ®åº“æ¶æ„)
5. [åº”ç”¨æ¶æ„](#åº”ç”¨æ¶æ„)
6. [é¡µé¢ä¸è·¯ç”±](#é¡µé¢ä¸è·¯ç”±)
7. [ç»„ä»¶ç›®å½•](#ç»„ä»¶ç›®å½•)
8. [ä¸šåŠ¡æµç¨‹](#ä¸šåŠ¡æµç¨‹)
9. [å›½é™…åŒ–æ–¹æ¡ˆ](#å›½é™…åŒ–æ–¹æ¡ˆ)
10. [å¼€å‘æŒ‡å—](#å¼€å‘æŒ‡å—)
11. [éƒ¨ç½²è¯´æ˜](#éƒ¨ç½²è¯´æ˜)

---

## é¡¹ç›®æ¦‚è¿°

### æ ¸å¿ƒç†å¿µ

è¿™æ˜¯ä¸€ä¸ªä»¥é¡¹ç›®ä¸ºä¸­å¿ƒçš„ NGO æèµ å¹³å°ï¼Œæ¯ä¸ªé¡¹ç›®éƒ½æ˜¯ç‹¬ç«‹çš„å®ä½“ï¼Œæ‹¥æœ‰è‡ªå·±çš„ç›®æ ‡ã€è¿›åº¦å’Œæèµ è¿½è¸ªç³»ç»Ÿã€‚

### ä¸»è¦ç‰¹æ€§

- âœ… **å¤šè¯­è¨€æ”¯æŒ**: å®Œæ•´çš„ä¸­æ–‡ã€è‹±æ–‡ã€ä¹Œå…‹å…°è¯­æ”¯æŒ
- âœ… **åœ¨çº¿æ”¯ä»˜**: WayForPay æ”¯ä»˜ç½‘å…³é›†æˆï¼ˆæ”¯æŒå®Œæ•´æ”¯ä»˜æµç¨‹çŠ¶æ€ï¼‰
- âœ… **å®æ—¶æ›´æ–°**: åŸºäº Supabase çš„å®æ—¶æ•°æ®åŒæ­¥
- âœ… **é‚®ä»¶é€šçŸ¥**: Resend è‡ªåŠ¨å‘é€æèµ ç¡®è®¤é‚®ä»¶ï¼ˆæ”¯æŒå¤šè¯­è¨€æ¨¡æ¿ï¼‰
- âœ… **æèµ è¿½è¸ª**: ç”¨æˆ·å¯æŸ¥è¯¢å’Œè¿½è¸ªæèµ çŠ¶æ€ï¼ˆæ”¯æŒè®¢å•åˆ†ç»„å±•ç¤ºï¼‰
- âœ… **ç®¡ç†å‘˜åå°**: é¡¹ç›®ç®¡ç†ã€æèµ çŠ¶æ€æ›´æ–°ã€é…é€ç®¡ç†
- âœ… **æ™ºèƒ½å›¾åƒå¤„ç†**: Cloudinary è‡ªåŠ¨å‹ç¼©ä¼˜åŒ– + AI äººè„¸éšç§ä¿æŠ¤
- âœ… **çµæ´»æèµ æ¨¡å¼**: æ”¯æŒç‰©èµ„æèµ ï¼ˆæŒ‰å•ä½æ‹†åˆ†ï¼‰å’Œé‡‘é¢æèµ ï¼ˆèšåˆæ¨¡å¼ï¼‰
- âœ… **å®‰å…¨å¯é **: å®Œæ•´çš„ RLS ç­–ç•¥ã€ç­¾åéªŒè¯å’Œå­—æ®µä¿æŠ¤è§¦å‘å™¨
- âœ… **æ‰©å±•çŠ¶æ€ç³»ç»Ÿ**: 15 ä¸ªæèµ çŠ¶æ€ï¼Œè¦†ç›–å®Œæ•´æ”¯ä»˜å’Œé€€æ¬¾æµç¨‹
- âœ… **é‚®ä»¶è®¢é˜…ç³»ç»Ÿ**: æ”¯æŒç”¨æˆ·è®¢é˜…é¡¹ç›®æ›´æ–°é€šçŸ¥å’Œç®¡ç†å‘˜ç¾¤å‘é‚®ä»¶ âœ¨ NEW
- âœ… **ç‹¬ç«‹é¡¹ç›®è¯¦æƒ…é¡µ**: æ¯ä¸ªé¡¹ç›®ç‹¬ç«‹å¼€å‘è¯¦æƒ…é¡µï¼Œæ”¯æŒè‡ªå®šä¹‰å†…å®¹å’Œå¸ƒå±€ âœ¨ NEW

### é¡¹ç›®ä¿¡æ¯

**å½“å‰ç‰ˆæœ¬**: 2.1.0
**æœ€åæ›´æ–°**: 2026-01-04
**å¼€å‘çŠ¶æ€**: ç”Ÿäº§å°±ç»ª

---

## æŠ€æœ¯æ ˆ

### å‰ç«¯æ¡†æ¶

- **Next.js 14** (App Router) - React æœåŠ¡ç«¯æ¸²æŸ“æ¡†æ¶
- **TypeScript** - ç±»å‹å®‰å…¨
- **Tailwind CSS** - åŸå­åŒ– CSS æ¡†æ¶
- **next-intl** - å›½é™…åŒ–è§£å†³æ–¹æ¡ˆ

### åç«¯æœåŠ¡

- **Supabase** - PostgreSQL æ•°æ®åº“ + è®¤è¯ + å®æ—¶è®¢é˜…
- **WayForPay** - ä¹Œå…‹å…°æ”¯ä»˜ç½‘å…³
- **Resend** - é‚®ä»¶å‘é€æœåŠ¡
- **Cloudinary** - å›¾åƒå¤„ç†ï¼ˆå‹ç¼© + äººè„¸æ‰“ç ï¼‰

### éƒ¨ç½²å¹³å°

- **Vercel** - å‰ç«¯æ‰˜ç®¡å’Œè¾¹ç¼˜å‡½æ•°
- **Supabase Cloud** - æ•°æ®åº“æ‰˜ç®¡

### å¼€å‘å·¥å…·

- **ESLint** + **Prettier** - ä»£ç è§„èŒƒ
- **Git** - ç‰ˆæœ¬æ§åˆ¶

---

## æ ¸å¿ƒåŠŸèƒ½

### 1. é¡¹ç›®å±•ç¤ºä¸ç®¡ç†

- é¡¹ç›®åˆ—è¡¨å±•ç¤ºï¼ˆç½‘æ ¼è§†å›¾ï¼‰
- é¡¹ç›®è¯¦æƒ…é¡µé¢
- å®æ—¶è¿›åº¦è¿½è¸ª
- å¤šè¯­è¨€é¡¹ç›®ä¿¡æ¯
- **åŒæ¨¡å¼æ”¯æŒ**ï¼šç‰©èµ„é¡¹ç›®ï¼ˆæŒ‰å•ä½è®¡ç®—ï¼‰å’Œæ‰“èµé¡¹ç›®ï¼ˆèšåˆé‡‘é¢ï¼‰

### 2. æèµ æµç¨‹

- é¡¹ç›®é€‰æ‹©ï¼ˆæ”¯æŒæœç´¢å’Œç­›é€‰ï¼‰
- **æ™ºèƒ½æèµ è¡¨å•**ï¼š
  - ç‰©èµ„é¡¹ç›®ï¼šæ•°é‡é€‰æ‹© + å•ä½ä»·æ ¼è®¡ç®—
  - æ‰“èµé¡¹ç›®ï¼šè‡ªå®šä¹‰é‡‘é¢è¾“å…¥
  - å¯é€‰å°è´¹åŠŸèƒ½
- WayForPay åœ¨çº¿æ”¯ä»˜
- æ”¯ä»˜æˆåŠŸç¡®è®¤ï¼ˆè½®è¯¢æ›´æ–°ï¼‰
- å¤šè¯­è¨€é‚®ä»¶é€šçŸ¥

### 3. æèµ è¿½è¸ª

- é‚®ç®± + æèµ  ID åŒé‡éªŒè¯æŸ¥è¯¢
- æèµ çŠ¶æ€å®æ—¶æ›´æ–°ï¼ˆ15 ä¸ªçŠ¶æ€ï¼‰
- è®¢å•åˆ†ç»„å±•ç¤ºï¼ˆåŒä¸€è®¢å•çš„å¤šä¸ªæèµ ï¼‰
- é€€æ¬¾ç”³è¯·ï¼ˆé€šè¿‡ WayForPay APIï¼‰
- é…é€ç»“æœæŸ¥çœ‹ï¼ˆå›¾ç‰‡å±•ç¤ºï¼‰

### 4. å¤šè¯­è¨€æ”¯æŒ

- 3 ç§è¯­è¨€ï¼ˆen/zh/uaï¼‰
- åŠ¨æ€è¯­è¨€åˆ‡æ¢
- æœåŠ¡ç«¯æ¸²æŸ“ç¿»è¯‘

### 5. ç®¡ç†å‘˜åå°

- ç®¡ç†å‘˜ç™»å½•/ç™»å‡º
- é¡¹ç›®åˆ›å»ºå’Œç¼–è¾‘
- æèµ çŠ¶æ€ç®¡ç†
- é…é€ç»“æœä¸Šä¼ 
- **é‚®ä»¶è®¢é˜…ç®¡ç†** âœ¨ NEW
  - æŸ¥çœ‹æ‰€æœ‰è®¢é˜…è€…åˆ—è¡¨
  - æŒ‰çŠ¶æ€/è¯­è¨€ç­›é€‰
  - å¤šé€‰è®¢é˜…è€…ç¾¤å‘é‚®ä»¶
  - é‚®ä»¶æ¨¡æ¿é€‰æ‹©å’Œé¢„è§ˆ

### 6. é‚®ä»¶è®¢é˜…ç³»ç»Ÿ âœ¨ NEW

- **ç”¨æˆ·è®¢é˜…**: æèµ æ—¶å¯é€‰æ‹©è®¢é˜…é¡¹ç›®æ›´æ–°
- **ä¸€é”®å–æ¶ˆè®¢é˜…**: é‚®ä»¶åº•éƒ¨å–æ¶ˆè®¢é˜…é“¾æ¥
- **å¤šè¯­è¨€ç¾¤å‘**: æ ¹æ®ç”¨æˆ·è¯­è¨€åå¥½å‘é€å¯¹åº”ç‰ˆæœ¬
- **æ¨¡æ¿ç®¡ç†**: æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨é‚®ä»¶æ¨¡æ¿

---

## æ•°æ®åº“æ¶æ„

### æ ¸å¿ƒè¡¨ç»“æ„

#### `projects` - é¡¹ç›®è¡¨

å­˜å‚¨æ‰€æœ‰ NGO é¡¹ç›®çš„ä¿¡æ¯å’Œè¿›åº¦ã€‚

**å…³é”®å­—æ®µ**:
- `id` - ä¸»é”®
- `project_name_i18n` - å¤šè¯­è¨€é¡¹ç›®åç§° (JSONB)
- `location_i18n` - å¤šè¯­è¨€åœ°ç‚¹ (JSONB)
- `target_units` - ç›®æ ‡å•ä½æ•°ï¼ˆç‰©èµ„é¡¹ç›®ï¼‰æˆ–ç›®æ ‡é‡‘é¢ï¼ˆæ‰“èµé¡¹ç›®ï¼‰
- `current_units` - å½“å‰å®Œæˆå•ä½æ•°ï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰
- `unit_price` - å•ä½ä»·æ ¼ï¼ˆç‰©èµ„é¡¹ç›®ï¼‰
- `aggregate_donations` - **èšåˆæ ‡å¿—** (TRUE=æ‰“èµæ¨¡å¼, FALSE=ç‰©èµ„æ¨¡å¼) âœ¨ NEW
- `is_long_term` - é•¿æœŸé¡¹ç›®æ ‡å¿—ï¼ˆæ— æˆªæ­¢æ—¥æœŸï¼‰
- `status` - é¡¹ç›®çŠ¶æ€ (planned/active/completed/paused)
- `description_i18n` - å¤šè¯­è¨€æè¿° (JSONB)

**çŠ¶æ€æµè½¬**: planned â†’ active â†’ completed/paused

**æèµ æ¨¡å¼**:
- **ç‰©èµ„æ¨¡å¼** (`aggregate_donations = false`): æŒ‰å•ä½æ‹†åˆ†æèµ è®°å½•ï¼ˆå¦‚ï¼š10 ä¸ªç¡è¢‹ = 10 æ¡è®°å½•ï¼‰
- **æ‰“èµæ¨¡å¼** (`aggregate_donations = true`): èšåˆä¸ºå•æ¡æèµ è®°å½•ï¼ˆå¦‚ï¼š$100 æèµ  = 1 æ¡è®°å½•ï¼‰

#### `donations` - æèµ è¡¨

è·Ÿè¸ªæ‰€æœ‰æèµ è®°å½•å’Œæ”¯ä»˜è¯¦æƒ…ã€‚

**å…³é”®å­—æ®µ**:
- `id` - ä¸»é”®
- `donation_public_id` - å…¬å¼€æèµ  IDï¼ˆæ ¼å¼ï¼š{é¡¹ç›®ID}-{6ä½éšæœºç }ï¼‰
- `project_id` - å…³è”é¡¹ç›®
- `donor_name` / `donor_email` - æèµ è€…ä¿¡æ¯
- `amount` - æèµ é‡‘é¢
- `order_reference` - WayForPay è®¢å•å·
- `donation_status` - æèµ çŠ¶æ€
- `locale` - ç”¨æˆ·è¯­è¨€ï¼ˆen/zh/uaï¼‰

**çŠ¶æ€æµè½¬** (15 ä¸ªçŠ¶æ€):
```
ç”¨æˆ·æèµ æµç¨‹ï¼š
pending â†’ processing â†’ fraud_check â†’ paid â†’ confirmed â†’ delivering â†’ completed
   â†“           â†“           â†“
widget_load_failed    expired/declined

é€€æ¬¾æµç¨‹ï¼š
paid/confirmed/delivering â†’ refunding â†’ refund_processing â†’ refunded

æ”¯ä»˜å¤±è´¥æµç¨‹ï¼š
pending â†’ failed/expired/declined
```

**çŠ¶æ€åˆ†ç±»**:
- **Pre-payment (æ”¯ä»˜å‰)**: pending, widget_load_failed
- **Processing (å¤„ç†ä¸­)**: processing, fraud_check
- **Payment Complete (æ”¯ä»˜å®Œæˆ)**: paid, confirmed, delivering, completed
- **Payment Failed (æ”¯ä»˜å¤±è´¥)**: expired, declined, failed
- **Refund (é€€æ¬¾)**: refunding, refund_processing, refunded

#### `email_subscriptions` - é‚®ä»¶è®¢é˜…è¡¨ âœ¨ NEW

å­˜å‚¨ç”¨æˆ·é‚®ä»¶è®¢é˜…ä¿¡æ¯ï¼Œç”¨äºæ–°é¡¹ç›®é€šçŸ¥ç¾¤å‘ã€‚

**å…³é”®å­—æ®µ**:
- `id` - ä¸»é”®
- `email` - è®¢é˜…è€…é‚®ç®±ï¼ˆå”¯ä¸€ï¼‰
- `locale` - è¯­è¨€åå¥½ (en/zh/ua)
- `is_subscribed` - è®¢é˜…çŠ¶æ€
- `updated_at` - æœ€åæ›´æ–°æ—¶é—´

**ç‰¹æ€§**:
- å¹‚ç­‰è®¢é˜…æ“ä½œï¼ˆé‡å¤è®¢é˜…åªæ›´æ–°è¯­è¨€ï¼‰
- è½¯åˆ é™¤ï¼ˆå–æ¶ˆè®¢é˜…åªä¿®æ”¹çŠ¶æ€ï¼‰
- ç®¡ç†å‘˜åªè¯»è®¿é—®ï¼ˆä¿®æ”¹é€šè¿‡å‡½æ•°ï¼‰

### æ•°æ®åº“è§†å›¾

| è§†å›¾å | ç”¨é€” | ç‰¹æ€§ |
|--------|------|------|
| `project_stats` | é¡¹ç›®ç»Ÿè®¡ä¿¡æ¯ | èšåˆæèµ æ€»é¢ã€è¿›åº¦ç™¾åˆ†æ¯”ã€**æ”¯æŒ aggregate_donations å­—æ®µ** |
| `public_project_donations` | å…¬å¼€æèµ åˆ—è¡¨ | é‚®ç®±æ··æ·†ä¿æŠ¤éšç§ã€**åŒ…å« order_id ç”¨äºåˆ†ç»„** |
| `order_donations_secure` | è®¢å•æèµ æŸ¥è¯¢ | ç”¨äºæ”¯ä»˜æˆåŠŸé¡µé¢ã€åŒ…å« pending çŠ¶æ€ |

### æ ¸å¿ƒæ•°æ®åº“å‡½æ•°

| å‡½æ•°å | ç”¨é€” | è¿”å›å€¼ |
|--------|------|--------|
| `generate_donation_public_id()` | ç”Ÿæˆå”¯ä¸€æèµ  IDï¼ˆé¡¹ç›®èŒƒå›´ï¼‰ | TEXT (å¦‚: 1-A1B2C3) |
| `get_donations_by_email_verified()` | éªŒè¯é‚®ç®±å¹¶æŸ¥è¯¢æèµ ï¼ˆ**å« order_reference**ï¼‰ | TABLE |
| `is_admin()` | æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜ | BOOLEAN |
| `update_project_units()` | è‡ªåŠ¨æ›´æ–°é¡¹ç›®è¿›åº¦ï¼ˆè§¦å‘å™¨å‡½æ•°ï¼‰ | TRIGGER |
| `prevent_donation_immutable_fields()` | ä¿æŠ¤ä¸å¯å˜å­—æ®µ + **çŠ¶æ€è½¬æ¢éªŒè¯** | TRIGGER |
| `prevent_project_immutable_fields()` | ä¿æŠ¤é¡¹ç›®ä¸å¯å˜å­—æ®µï¼ˆ**å« aggregate_donations**ï¼‰ | TRIGGER |
| `upsert_email_subscription()` | è®¢é˜…æˆ–æ›´æ–°é‚®ä»¶è®¢é˜…ï¼ˆå¹‚ç­‰æ“ä½œï¼‰âœ¨ NEW | BIGINT |
| `unsubscribe_email()` | å–æ¶ˆé‚®ä»¶è®¢é˜… âœ¨ NEW | BOOLEAN |

### å®‰å…¨æœºåˆ¶

- âœ… **RLS (è¡Œçº§å®‰å…¨)**: æ‰€æœ‰è¡¨å¯ç”¨ RLS ç­–ç•¥ï¼ˆ14 ä¸ªç­–ç•¥ï¼‰
- âœ… **åŒå®¢æˆ·ç«¯æ¨¡å¼**:
  - å¸¸è§„å®¢æˆ·ç«¯: ç”¨æˆ·æ“ä½œï¼ˆå¼ºåˆ¶ RLSï¼‰
  - æœåŠ¡è§’è‰²å®¢æˆ·ç«¯: Webhook æ“ä½œï¼ˆç»•è¿‡ RLSï¼‰
- âœ… **å­—æ®µä¿æŠ¤è§¦å‘å™¨**:
  - ä¿æŠ¤é¡¹ç›®ä¸å¯å˜å­—æ®µï¼šid, created_at, aggregate_donations, is_long_term
  - ä¿æŠ¤æèµ ä¸å¯å˜å­—æ®µï¼šid, donation_public_id, project_id, donor_name, donor_email, amount, order_reference, created_at
- âœ… **çŠ¶æ€è½¬æ¢éªŒè¯**:
  - ç®¡ç†å‘˜åªèƒ½æ‰§è¡Œ 3 ä¸ªä¸šåŠ¡æµç¨‹è½¬æ¢ï¼ˆpaidâ†’confirmed, confirmedâ†’delivering, deliveringâ†’completedï¼‰
  - é€€æ¬¾çŠ¶æ€ç”± WayForPay API è‡ªåŠ¨å¤„ç†
  - æ•°æ®åº“è§¦å‘å™¨å¼ºåˆ¶æ‰§è¡Œ
- âœ… **é‚®ç®±æ··æ·†**: å…¬å¼€è§†å›¾ä¸­é‚®ç®±è‡ªåŠ¨æ··æ·†ï¼ˆå¦‚: j***e@e***.comï¼‰
- âœ… **é˜²æšä¸¾æ”»å‡»**: æŸ¥è¯¢éœ€è¦é‚®ç®±+æèµ IDåŒé‡éªŒè¯
- âœ… **åŒ¿åç”¨æˆ·é™åˆ¶**: åªèƒ½åˆ›å»º pending çŠ¶æ€æèµ ã€æ›´æ–°ä¸º widget_load_failed

> è¯¦ç»†çš„æ•°æ®åº“æ–‡æ¡£è¯·å‚è€ƒ: [docs/DATABASE_SCHEMA.md](docs/DATABASE_SCHEMA.md) (38 ä¸ªè¿ç§»æ–‡ä»¶)

---

## åº”ç”¨æ¶æ„

### ç›®å½•ç»“æ„

```
NGO_web/
â”œâ”€â”€ app/                          # Next.js App Router
â”‚   â”œâ”€â”€ [locale]/                 # å›½é™…åŒ–è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ page.tsx              # ä¸»é¡µ
â”‚   â”‚   â”œâ”€â”€ donate/               # æèµ æµç¨‹
â”‚   â”‚   â”œâ”€â”€ track-donation/       # æèµ è¿½è¸ª
â”‚   â”‚   â”œâ”€â”€ unsubscribed/         # å–æ¶ˆè®¢é˜…æˆåŠŸé¡µ âœ¨ NEW
â”‚   â”‚   â”œâ”€â”€ privacy-policy/       # éšç§æ”¿ç­–
â”‚   â”‚   â””â”€â”€ public-agreement/     # å…¬å¼€åè®®
â”‚   â”œâ”€â”€ admin/                    # ç®¡ç†å‘˜åå°
â”‚   â”‚   â”œâ”€â”€ layout.tsx            # ç®¡ç†å‘˜å¸ƒå±€
â”‚   â”‚   â”œâ”€â”€ login/                # ç®¡ç†å‘˜ç™»å½•
â”‚   â”‚   â”œâ”€â”€ projects/             # é¡¹ç›®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ donations/            # æèµ ç®¡ç†
â”‚   â”‚   â””â”€â”€ subscriptions/        # é‚®ä»¶è®¢é˜…ç®¡ç† âœ¨ NEW
â”‚   â”œâ”€â”€ actions/                  # Server Actions
â”‚   â”‚   â”œâ”€â”€ admin.ts              # ç®¡ç†å‘˜æ“ä½œ
â”‚   â”‚   â”œâ”€â”€ donation.ts           # æèµ åˆ›å»º
â”‚   â”‚   â”œâ”€â”€ donation-result.ts    # æèµ ç»“æœæŸ¥è¯¢
â”‚   â”‚   â”œâ”€â”€ track-donation.ts     # æèµ è¿½è¸ª
â”‚   â”‚   â”œâ”€â”€ subscription.ts       # é‚®ä»¶è®¢é˜… âœ¨ NEW
â”‚   â”‚   â””â”€â”€ email-broadcast.ts    # ç¾¤å‘é‚®ä»¶ âœ¨ NEW
â”‚   â””â”€â”€ api/                      # API è·¯ç”±
â”‚       â”œâ”€â”€ webhooks/wayforpay/   # WayForPay å›è°ƒ
â”‚       â”œâ”€â”€ donations/            # æèµ æŸ¥è¯¢ API
â”‚       â””â”€â”€ unsubscribe/          # å–æ¶ˆè®¢é˜… API âœ¨ NEW
â”œâ”€â”€ components/                   # React ç»„ä»¶
â”‚   â”œâ”€â”€ admin/                    # ç®¡ç†å‘˜ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ SubscriptionsTable.tsx  # è®¢é˜…ç®¡ç†è¡¨æ ¼ âœ¨ NEW
â”‚   â”‚   â””â”€â”€ BroadcastModal.tsx      # ç¾¤å‘é‚®ä»¶æ¨¡æ€æ¡† âœ¨ NEW
â”‚   â”œâ”€â”€ home/                     # ä¸»é¡µç»„ä»¶
â”‚   â”œâ”€â”€ projects/                 # é¡¹ç›®ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ detail-pages/         # é¡¹ç›®è¯¦æƒ…é¡µç»„ä»¶ âœ¨ NEW
â”‚   â”‚   â”‚   â”œâ”€â”€ Project0/         # é¡¹ç›®0 è¯¦æƒ…ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ Project3/         # é¡¹ç›®3 è¯¦æƒ…ç»„ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ index.ts          # ç»Ÿä¸€å¯¼å‡º
â”‚   â”‚   â”œâ”€â”€ shared/               # å…±äº«åŸºç¡€ç»„ä»¶ âœ¨ NEW
â”‚   â”‚   â”‚   â”œâ”€â”€ ProjectProgressBar.tsx
â”‚   â”‚   â”‚   â””â”€â”€ ProjectResultsMasonry.tsx
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ donate/                   # æèµ ç»„ä»¶
â”‚   â””â”€â”€ ...                       # å…¶ä»–ç»„ä»¶
â”œâ”€â”€ lib/                          # å·¥å…·åº“
â”‚   â”œâ”€â”€ supabase/                 # Supabase é›†æˆ
â”‚   â”‚   â”œâ”€â”€ admin-auth.ts         # ç®¡ç†å‘˜è®¤è¯
â”‚   â”‚   â”œâ”€â”€ queries.ts            # æ•°æ®åº“æŸ¥è¯¢
â”‚   â”‚   â””â”€â”€ server.ts             # æœåŠ¡ç«¯å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ wayforpay/                # WayForPay é›†æˆ
â”‚   â”œâ”€â”€ email/                    # é‚®ä»¶æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ templates/            # é‚®ä»¶æ¨¡æ¿ç³»ç»Ÿ âœ¨ NEW
â”‚   â”‚   â”‚   â”œâ”€â”€ transactional/    # äº‹åŠ¡æ€§é‚®ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ broadcast/        # ç¾¤å‘é‚®ä»¶æ¨¡æ¿å®šä¹‰
â”‚   â”‚   â”‚   â”œâ”€â”€ content/          # ç¾¤å‘é‚®ä»¶ HTML å†…å®¹
â”‚   â”‚   â”‚   â””â”€â”€ index.ts          # æ¨¡æ¿åŠ è½½å™¨
â”‚   â”‚   â””â”€â”€ broadcast.ts          # ç¾¤å‘é‚®ä»¶å‘é€ âœ¨ NEW
â”‚   â”œâ”€â”€ cloudinary.ts             # Cloudinary å›¾åƒå¤„ç†
â”‚   â”œâ”€â”€ validations.ts            # Zod éªŒè¯
â”‚   â”œâ”€â”€ utils.ts                  # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ i18n-utils.ts             # å›½é™…åŒ–å·¥å…·
â”œâ”€â”€ messages/                     # ç¿»è¯‘æ–‡ä»¶
â”‚   â”œâ”€â”€ en.json                   # è‹±æ–‡
â”‚   â”œâ”€â”€ zh.json                   # ä¸­æ–‡
â”‚   â””â”€â”€ ua.json                   # ä¹Œå…‹å…°è¯­
â”œâ”€â”€ public/content/projects/      # é¡¹ç›®å†…å®¹ JSON âœ¨ NEW
â”‚   â”œâ”€â”€ project-0-en.json         # é¡¹ç›®0 è‹±æ–‡å†…å®¹
â”‚   â”œâ”€â”€ project-0-zh.json         # é¡¹ç›®0 ä¸­æ–‡å†…å®¹
â”‚   â””â”€â”€ ...
â”œâ”€â”€ types/                        # TypeScript ç±»å‹
â”‚   â”œâ”€â”€ database.ts               # æ•°æ®åº“ç±»å‹ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â”‚   â””â”€â”€ index.ts                  # åº”ç”¨ç±»å‹
â”œâ”€â”€ supabase/                     # Supabase é…ç½®
â”‚   â””â”€â”€ migrations/               # æ•°æ®åº“è¿ç§»
â”œâ”€â”€ docs/                         # é¡¹ç›®æ–‡æ¡£
â”‚   â”œâ”€â”€ DATABASE_SCHEMA.md        # æ•°æ®åº“æ¶æ„
â”‚   â”œâ”€â”€ EMAIL_SUBSCRIPTION_DESIGN.md  # é‚®ä»¶è®¢é˜…è®¾è®¡ âœ¨ NEW
â”‚   â””â”€â”€ PROJECT_DETAIL_ARCHITECTURE.md # é¡¹ç›®è¯¦æƒ…æ¶æ„ âœ¨ NEW
â”œâ”€â”€ i18n/                         # å›½é™…åŒ–é…ç½®
â”œâ”€â”€ middleware.ts                 # Next.js ä¸­é—´ä»¶
â””â”€â”€ CLAUDE.md                     # æœ¬æ–‡æ¡£
```

### æ¶æ„è®¾è®¡åŸåˆ™

1. **æœåŠ¡ç«¯ä¼˜å…ˆ**: é»˜è®¤ä½¿ç”¨ React Server Components
2. **ç±»å‹å®‰å…¨**: TypeScript ä¸¥æ ¼æ¨¡å¼ + Zod è¿è¡Œæ—¶éªŒè¯
3. **å›½é™…åŒ–ä¼˜å…ˆ**: æ‰€æœ‰æ–‡æœ¬æ”¯æŒå¤šè¯­è¨€
4. **å®‰å…¨ç¬¬ä¸€**: RLS + ç­¾åéªŒè¯ + è¾“å…¥éªŒè¯
5. **ç”¨æˆ·ä½“éªŒ**: å®æ—¶æ›´æ–° + ä¼˜åŒ–åŠ è½½çŠ¶æ€

---

## é¡µé¢ä¸è·¯ç”±

### å…¬å¼€é¡µé¢

| è·¯å¾„ | ç»„ä»¶ | åŠŸèƒ½ | ç‰¹æ€§ |
|------|------|------|------|
| `/[locale]/` | `page.tsx` | ä¸»é¡µ | å±•ç¤ºä½¿å‘½ã€é¡¹ç›®ã€å½±å“åŠ› |
| `/[locale]/donate` | `donate/page.tsx` | æèµ é¡µé¢ | é¡¹ç›®é€‰æ‹© + æèµ è¡¨å• |
| `/[locale]/donate/success` | `donate/success/page.tsx` | æ”¯ä»˜æˆåŠŸé¡µ | å±•ç¤ºæèµ è¯¦æƒ… |
| `/[locale]/track-donation` | `track-donation/page.tsx` | æèµ è¿½è¸ª | é‚®ç®±éªŒè¯æŸ¥è¯¢ |
| `/[locale]/unsubscribed` | `unsubscribed/page.tsx` | å–æ¶ˆè®¢é˜…æˆåŠŸé¡µ âœ¨ NEW | ç¡®è®¤å–æ¶ˆè®¢é˜… |
| `/[locale]/privacy-policy` | `privacy-policy/page.tsx` | éšç§æ”¿ç­– | æ³•å¾‹å£°æ˜ |
| `/[locale]/public-agreement` | `public-agreement/page.tsx` | å…¬å¼€åè®® | æèµ æ¡æ¬¾ |

### API ç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | ç”¨é€” |
|------|------|------|
| `/api/webhooks/wayforpay` | POST | WayForPay æ”¯ä»˜å›è°ƒ |
| `/api/donations/order/[orderReference]` | GET | æŸ¥è¯¢è®¢å•çš„æ‰€æœ‰æèµ  |
| `/api/donations/project-public/[projectId]` | GET | æŸ¥è¯¢é¡¹ç›®å…¬å¼€æèµ åˆ—è¡¨ |
| `/api/donate/success-redirect` | GET/POST | WayForPay é‡å®šå‘å¤„ç† |
| `/api/unsubscribe` | GET/POST | å–æ¶ˆé‚®ä»¶è®¢é˜… âœ¨ NEW |

### ç®¡ç†å‘˜é¡µé¢

| è·¯å¾„ | ç»„ä»¶ | åŠŸèƒ½ | æƒé™ |
|------|------|------|------|
| `/admin/login` | `admin/login/page.tsx` | ç®¡ç†å‘˜ç™»å½• | å…¬å¼€ |
| `/admin/projects` | `admin/projects/page.tsx` | é¡¹ç›®ç®¡ç† | éœ€è¦ç™»å½• |
| `/admin/donations` | `admin/donations/page.tsx` | æèµ ç®¡ç† | éœ€è¦ç™»å½• |
| `/admin/subscriptions` | `admin/subscriptions/page.tsx` | é‚®ä»¶è®¢é˜…ç®¡ç† âœ¨ NEW | éœ€è¦ç™»å½• |

### Server Actions

| æ–‡ä»¶ | ä¸»å‡½æ•° | ç”¨é€” |
|------|--------|------|
| `actions/donation.ts` | `createWayForPayDonation()` | åˆ›å»ºæèµ å¹¶ç”Ÿæˆæ”¯ä»˜å‚æ•° |
| `actions/donation-result.ts` | `getDonationResultUrl()` | è·å–æèµ ç»“æœå›¾ç‰‡ |
| `actions/track-donation.ts` | `trackDonations()` | è¿½è¸ªæèµ è®°å½• |
| `actions/track-donation.ts` | `requestRefund()` | ç”³è¯·é€€æ¬¾ |
| `actions/admin.ts` | `adminLogin()` | ç®¡ç†å‘˜ç™»å½• (æ–°å¢) |
| `actions/admin.ts` | `adminLogout()` | ç®¡ç†å‘˜ç™»å‡º (æ–°å¢) |
| `actions/admin.ts` | `getAdminProjects()` | è·å–æ‰€æœ‰é¡¹ç›® (æ–°å¢) |
| `actions/admin.ts` | `createProject()` | åˆ›å»ºé¡¹ç›® (æ–°å¢) |
| `actions/admin.ts` | `updateProject()` | æ›´æ–°é¡¹ç›® (æ–°å¢) |
| `actions/admin.ts` | `getAdminDonations()` | è·å–æ‰€æœ‰æèµ  |
| `actions/admin.ts` | `updateDonationStatus()` | æ›´æ–°æèµ çŠ¶æ€ |
| `actions/subscription.ts` | `createEmailSubscription()` | åˆ›å»ºé‚®ä»¶è®¢é˜… âœ¨ NEW |
| `actions/subscription.ts` | `getSubscriptions()` | è·å–è®¢é˜…åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ï¼‰âœ¨ NEW |
| `actions/subscription.ts` | `getSubscriptionStats()` | è·å–è®¢é˜…ç»Ÿè®¡ âœ¨ NEW |
| `actions/email-broadcast.ts` | `sendEmailBroadcast()` | å‘é€ç¾¤å‘é‚®ä»¶ âœ¨ NEW |
| `actions/email-broadcast.ts` | `getAvailableBroadcastTemplates()` | è·å–å¯ç”¨æ¨¡æ¿ âœ¨ NEW |
| `actions/email-broadcast.ts` | `previewEmailTemplate()` | é¢„è§ˆé‚®ä»¶æ¨¡æ¿ âœ¨ NEW |

---

## ç»„ä»¶ç›®å½•

### å¸ƒå±€ç»„ä»¶

| ç»„ä»¶ | æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|------|
| Navigation | `Navigation.tsx` | å¯¼èˆªæ ï¼ˆLogo + è¯­è¨€åˆ‡æ¢ + æ“ä½œæŒ‰é’®ï¼‰ |
| Footer | `Footer.tsx` | é¡µè„šï¼ˆç¤¾äº¤é“¾æ¥ + è”ç³»ä¿¡æ¯ + æ”¿ç­–é“¾æ¥ï¼‰ |

### ä¸»é¡µç»„ä»¶

ä½äº `components/home/` ç›®å½•:

| ç»„ä»¶ | ç”¨é€” |
|------|------|
| MissionSection | ä½¿å‘½å®£è¨€å±•ç¤º |
| ApproachSection | å·¥ä½œæ–¹æ³•ä»‹ç» |
| ImpactSection | å½±å“åŠ›æ•°æ®å±•ç¤º |
| DonationJourneySection | æèµ æµç¨‹è¯´æ˜ |
| ComplianceSection | åˆè§„ä¿¡æ¯å±•ç¤º |

### é¡¹ç›®ç»„ä»¶

ä½äº `components/projects/` ç›®å½•:

| ç»„ä»¶ | ç”¨é€” | ç±»å‹ |
|------|------|------|
| ProjectsGrid | é¡¹ç›®ç½‘æ ¼å±•ç¤º | Server Component |
| ProjectCard | é¡¹ç›®å¡ç‰‡ï¼ˆå®Œæ•´æ¨¡å¼ï¼‰ | Client Component |
| ProjectCardCompact | é¡¹ç›®å¡ç‰‡ï¼ˆç´§å‡‘æ¨¡å¼ï¼‰ | Client Component |
| ProjectProgressCard | è¿›åº¦å¡ç‰‡ | Client Component |
| ProjectsGallery | é¡¹ç›®é€‰æ‹©åº“ | Client Component |
| ProjectResultsSection | é¡¹ç›®æˆæœå±•ç¤º | Client Component |

**é¡¹ç›®è¯¦æƒ…é¡µç»„ä»¶** (ä½äº `components/projects/detail-pages/`): âœ¨ NEW

| ç»„ä»¶ | é¡¹ç›® | è¯´æ˜ |
|------|------|------|
| Project0DetailContent | é¡¹ç›®0 (Way to Health) | åº·å¤ä¸­å¿ƒè¯¦æƒ…é¡µ |
| Project3DetailContent | é¡¹ç›®3 (åœ£è¯ç¤¼ç‰©) | åœ£è¯ç¤¼ç‰©è®¡åˆ’è¯¦æƒ…é¡µ |

æ¯ä¸ªé¡¹ç›®ç‹¬ç«‹å¼€å‘è¯¦æƒ…é¡µç»„ä»¶ï¼Œæ”¯æŒè‡ªå®šä¹‰å¸ƒå±€å’Œå†…å®¹ã€‚è¯¦è§ [PROJECT_DETAIL_ARCHITECTURE.md](docs/PROJECT_DETAIL_ARCHITECTURE.md)

**å…±äº«ç»„ä»¶** (ä½äº `components/projects/shared/`): âœ¨ NEW

| ç»„ä»¶ | ç”¨é€” |
|------|------|
| ProjectProgressBar | è¿›åº¦æ¡ç»„ä»¶ |
| ProjectResultsMasonry | ç€‘å¸ƒæµå›¾ç‰‡å±•ç¤º |

### æèµ ç»„ä»¶

ä½äº `components/donate/` å’Œ `components/donation/` ç›®å½•:

| ç»„ä»¶ | ç”¨é€” | å…³é”®åŠŸèƒ½ |
|------|------|----------|
| DonationFormCard | æèµ è¡¨å• | è¡¨å•éªŒè¯ + è°ƒç”¨ Server Action |
| DonationStatusFlow | çŠ¶æ€æµç¨‹å¯è§†åŒ– | å±•ç¤ºæèµ çŠ¶æ€è½¬æ¢ |
| ProjectDonationList | é¡¹ç›®æèµ åˆ—è¡¨ | å±•ç¤ºå…¬å¼€æèµ è®°å½• |
| DonationResultViewer | æèµ ç»“æœæŸ¥çœ‹å™¨ | å±•ç¤ºé…é€å®Œæˆç…§ç‰‡ |
| ProjectSelector | é¡¹ç›®é€‰æ‹©å™¨ | é¡¹ç›®æœç´¢å’Œç­›é€‰ |

### å·¥å…·ç»„ä»¶

| ç»„ä»¶ | æ–‡ä»¶ | ç”¨é€” |
|------|------|------|
| CopyButton | `CopyButton.tsx` | å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿ |
| LanguageSwitcher | `LanguageSwitcher.tsx` | è¯­è¨€åˆ‡æ¢ä¸‹æ‹‰èœå• |

### ç®¡ç†å‘˜ç»„ä»¶ (æ–°å¢)

ä½äº `components/admin/` ç›®å½•:

| ç»„ä»¶ | ç”¨é€” | ç±»å‹ |
|------|------|------|
| AdminNav | ç®¡ç†å‘˜å¯¼èˆªæ ï¼ˆç™»å‡ºæŒ‰é’®ã€é¡µé¢å¯¼èˆªï¼‰ | Client Component |
| ProjectsTable | é¡¹ç›®åˆ—è¡¨è¡¨æ ¼ï¼ˆç¼–è¾‘ã€çŠ¶æ€ç®¡ç†ï¼‰ | Client Component |
| ProjectEditModal | é¡¹ç›®ç¼–è¾‘æ¨¡æ€æ¡†ï¼ˆå¤šè¯­è¨€è¡¨å•ï¼‰ | Client Component |
| DonationsTable | æèµ åˆ—è¡¨è¡¨æ ¼ï¼ˆçŠ¶æ€æ›´æ–°ï¼‰ | Client Component |
| DonationEditModal | æèµ ç¼–è¾‘æ¨¡æ€æ¡†ï¼ˆçŠ¶æ€è½¬æ¢ã€ç»“æœä¸Šä¼ ï¼‰ | Client Component |
| SubscriptionsTable | è®¢é˜…è€…åˆ—è¡¨ï¼ˆå¤šé€‰ã€ç¾¤å‘ï¼‰âœ¨ NEW | Client Component |
| BroadcastModal | ç¾¤å‘é‚®ä»¶æ¨¡æ€æ¡†ï¼ˆæ¨¡æ¿é€‰æ‹©ã€é¢„è§ˆï¼‰âœ¨ NEW | Client Component |

---

## ä¸šåŠ¡æµç¨‹

### å®Œæ•´æèµ æµç¨‹

```
1. ç”¨æˆ·è¿›å…¥æèµ é¡µé¢
   â†“
2. é€‰æ‹©é¡¹ç›®ï¼ˆæ”¯æŒæœç´¢å’Œç­›é€‰ï¼‰
   â†“
3. å¡«å†™æèµ è¡¨å•
   â”œâ”€ ç‰©èµ„é¡¹ç›®ï¼šé€‰æ‹©æ•°é‡ï¼ˆå¦‚ï¼š10 ä¸ªç¡è¢‹ï¼‰
   â””â”€ æ‰“èµé¡¹ç›®ï¼šè¾“å…¥è‡ªå®šä¹‰é‡‘é¢ï¼ˆå¦‚ï¼š$100ï¼‰
   â†“
4. æäº¤è¡¨å• â†’ Server Action: createWayForPayDonation()
   â†“
5. éªŒè¯é¡¹ç›®çŠ¶æ€å’Œæ•°é‡/é‡‘é¢é™åˆ¶
   â”œâ”€ ç‰©èµ„é¡¹ç›®ï¼šæ£€æŸ¥å‰©ä½™å•ä½æ•°
   â””â”€ æ‰“èµé¡¹ç›®ï¼šæ£€æŸ¥å‰©ä½™ç›®æ ‡é‡‘é¢
   â†“
6. åˆ›å»ºæèµ è®°å½•ï¼ˆpending çŠ¶æ€ï¼‰
   â”œâ”€ ç‰©èµ„é¡¹ç›®ï¼šä¸ºæ¯ä¸ªå•ä½åˆ›å»ºä¸€æ¡è®°å½•ï¼ˆ10 ä¸ª = 10 æ¡ï¼‰
   â””â”€ æ‰“èµé¡¹ç›®ï¼šåˆ›å»ºå•æ¡èšåˆè®°å½•ï¼ˆ$100 = 1 æ¡ï¼‰
   â†“
7. ç”Ÿæˆæ”¯ä»˜å‚æ•°å’Œ MD5 ç­¾å
   â†“
8. åŠ è½½ WayForPay æ”¯ä»˜å°éƒ¨ä»¶
   â†“
9. ç”¨æˆ·å®Œæˆæ”¯ä»˜
   â†“
10. WayForPay Webhook å›è°ƒ /api/webhooks/wayforpay
    â”œâ”€ éªŒè¯ç­¾å
    â”œâ”€ æ›´æ–°æèµ çŠ¶æ€ï¼ˆpending â†’ paid/processing/fraud_checkï¼‰
    â”œâ”€ å‘é€å¤šè¯­è¨€ç¡®è®¤é‚®ä»¶ï¼ˆResendï¼‰
    â””â”€ è§¦å‘å™¨è‡ªåŠ¨æ›´æ–°é¡¹ç›®è¿›åº¦
   â†“
11. é‡å®šå‘åˆ° /donate/success?order={orderReference}
   â†“
12. æˆåŠŸé¡µé¢è½®è¯¢è·å–æèµ è¯¦æƒ…ï¼ˆåŒ…å« pending çŠ¶æ€ï¼‰
   â†“
13. å±•ç¤ºæèµ  IDã€è®¢å•åˆ†ç»„å’Œç¡®è®¤ä¿¡æ¯
```

### æèµ çŠ¶æ€è½¬æ¢ (15 ä¸ªçŠ¶æ€)

```
æ­£å¸¸æµç¨‹ï¼š
pending (å¾…æ”¯ä»˜)
  â†“ WayForPay å¤„ç†
processing (å¤„ç†ä¸­)
  â†“ åæ¬ºè¯ˆæ£€æŸ¥
fraud_check (å®¡æ ¸ä¸­)
  â†“ æ”¯ä»˜æˆåŠŸ
paid (å·²æ”¯ä»˜)
  â†“ NGO ç¡®è®¤
confirmed (å·²ç¡®è®¤)
  â†“ å¼€å§‹é…é€
delivering (é…é€ä¸­)
  â†“ é…é€å®Œæˆ
completed (å·²å®Œæˆ)

é€€æ¬¾æµç¨‹ï¼š
paid/confirmed/delivering
  â†“ ç”¨æˆ·ç”³è¯·é€€æ¬¾
refunding (é€€æ¬¾ä¸­)
  â†“ WayForPay å¤„ç†
refund_processing (é€€æ¬¾å¤„ç†ä¸­)
  â†“ é€€æ¬¾å®Œæˆ
refunded (å·²é€€æ¬¾)

æ”¯ä»˜å¤±è´¥æµç¨‹ï¼š
pending
  â†“
widget_load_failed (çª—å£åŠ è½½å¤±è´¥)
expired (æ”¯ä»˜è¶…æ—¶)
declined (é“¶è¡Œæ‹’ç»)
failed (å…¶ä»–å¤±è´¥)
```

**çŠ¶æ€è¯´æ˜**:
- **ç®¡ç†å‘˜å¯ä¿®æ”¹**: paid â†’ confirmed â†’ delivering â†’ completed
- **WayForPay è‡ªåŠ¨**: pending â†” processing/fraud_check/expired/declined
- **é€€æ¬¾ç³»ç»Ÿ**: refunding â†” refund_processing â†’ refunded
- **å®¢æˆ·ç«¯é”™è¯¯**: pending â†’ widget_load_failed

### æèµ è¿½è¸ªæµç¨‹

```
1. ç”¨æˆ·è¿›å…¥ /track-donation
   â†“
2. è¾“å…¥é‚®ç®±å’Œæèµ  IDï¼ˆä»»æ„ä¸€ä¸ªå³å¯ï¼‰
   â†“
3. æäº¤æŸ¥è¯¢ â†’ trackDonations() Server Action
   â†“
4. è°ƒç”¨æ•°æ®åº“å‡½æ•° get_donations_by_email_verified()
   â”œâ”€ éªŒè¯æ‰€æœ‰æƒï¼ˆé‚®ç®± + æèµ  IDï¼‰
   â”œâ”€ é˜²æ­¢æšä¸¾æ”»å‡»ï¼ˆåŒé‡éªŒè¯ï¼‰
   â””â”€ è¿”å› order_reference ç”¨äºåˆ†ç»„
   â†“
5. è¿”å›è¯¥é‚®ç®±çš„æ‰€æœ‰æèµ è®°å½•
   â†“
6. å‰ç«¯æŒ‰ order_reference åˆ†ç»„å±•ç¤º
   â”œâ”€ åŒä¸€è®¢å•çš„å¤šä¸ªæèµ æ˜¾ç¤ºä¸ºä¸€ç»„
   â”œâ”€ ç‰©èµ„é¡¹ç›®ï¼šæ˜¾ç¤ºæ•°é‡å’Œå•ä½
   â””â”€ æ‰“èµé¡¹ç›®ï¼šæ˜¾ç¤ºæ€»é‡‘é¢
   â†“
7. å±•ç¤ºè¯¦ç»†ä¿¡æ¯
   â”œâ”€ æèµ  IDã€é¡¹ç›®åç§°ã€é‡‘é¢
   â”œâ”€ å½“å‰çŠ¶æ€ï¼ˆ15 ä¸ªçŠ¶æ€ä¹‹ä¸€ï¼‰
   â”œâ”€ æ›´æ–°æ—¶é—´ï¼ˆå®æ—¶ï¼‰
   â””â”€ é…é€ç»“æœå›¾ç‰‡ï¼ˆcompleted çŠ¶æ€ï¼‰
   â†“
8. ç”¨æˆ·å¯é€‰æ‹©ç”³è¯·é€€æ¬¾ï¼ˆè°ƒç”¨ WayForPay APIï¼‰
```

---

## ç®¡ç†å‘˜åŠŸèƒ½

### ç³»ç»Ÿæ¶æ„

ç®¡ç†å‘˜ç³»ç»Ÿé‡‡ç”¨åŸºäº Supabase Auth çš„è®¤è¯æ–¹æ¡ˆï¼Œåªæœ‰ç®¡ç†å‘˜ç™»å½•åŠŸèƒ½ï¼Œæ— ç”¨æˆ·æ³¨å†Œã€‚

#### è®¤è¯é€»è¾‘

```
ç™»å½•ç”¨æˆ· = ç®¡ç†å‘˜
åˆ¤æ–­ä¾æ®: auth.uid() IS NOT NULL
```

**ç‰¹ç‚¹**:
- âœ… ç®€åŒ–çš„æƒé™æ¨¡å‹ï¼ˆåªæœ‰ç®¡ç†å‘˜å’ŒåŒ¿åç”¨æˆ·ä¸¤ç§è§’è‰²ï¼‰
- âœ… åŸºäº Supabase RLS çš„å®‰å…¨ä¿æŠ¤
- âœ… æ•°æ®åº“çº§å­—æ®µä¿æŠ¤ï¼ˆè§¦å‘å™¨ï¼‰
- âœ… åº”ç”¨å±‚åŒé‡éªŒè¯

### åŠŸèƒ½æ¨¡å—

#### 1. ç®¡ç†å‘˜ç™»å½•

**è·¯å¾„**: `/admin/login`

**åŠŸèƒ½**:
- é‚®ç®± + å¯†ç ç™»å½•
- Session æŒä¹…åŒ–
- ç™»å½•å¤±è´¥æç¤º

**å®ç°**:
```typescript
// Server Action
await adminLogin(email, password)

// åº•å±‚ä½¿ç”¨ Supabase Auth
supabase.auth.signInWithPassword({ email, password })
```

**å®‰å…¨ç‰¹æ€§**:
- âœ… HTTPS åŠ å¯†ä¼ è¾“
- âœ… Session Cookie ä¿æŠ¤
- âœ… ç™»å½•å¤±è´¥ä¸æ³„éœ²è´¦æˆ·ä¿¡æ¯

---

#### 2. é¡¹ç›®ç®¡ç†

**è·¯å¾„**: `/admin/projects`

**åŠŸèƒ½**:
- æŸ¥çœ‹æ‰€æœ‰é¡¹ç›®åˆ—è¡¨
- åˆ›å»ºæ–°é¡¹ç›®
- ç¼–è¾‘ç°æœ‰é¡¹ç›®
- æ›´æ–°é¡¹ç›®çŠ¶æ€

**æƒé™æ§åˆ¶**:
```sql
-- RLS ç­–ç•¥
CREATE POLICY "Admins can insert projects" ON projects
FOR INSERT TO authenticated WITH CHECK (is_admin());

CREATE POLICY "Admins can update projects" ON projects
FOR UPDATE TO authenticated USING (is_admin());
```

**å­—æ®µä¿æŠ¤**:
- âœ… **å¯ç¼–è¾‘å­—æ®µ**: project_name_i18n, location_i18n, description_i18n, target_units, unit_price, status ç­‰
- âŒ **ä¸å¯ç¼–è¾‘å­—æ®µ** (è§¦å‘å™¨ä¿æŠ¤):
  - `id` - ä¸»é”®
  - `created_at` - åˆ›å»ºæ—¶é—´
  - `aggregate_donations` - æèµ æ¨¡å¼ï¼ˆåˆ›å»ºåä¸å¯æ”¹ï¼‰
  - `is_long_term` - é•¿æœŸæ ‡å¿—ï¼ˆåˆ›å»ºåä¸å¯æ”¹ï¼‰
- âš™ï¸ **è‡ªåŠ¨æ›´æ–°å­—æ®µ**: updated_at, current_unitsï¼ˆè§¦å‘å™¨è‡ªåŠ¨æ›´æ–°ï¼‰

**çŠ¶æ€ç®¡ç†**:
```
planned (è®¡åˆ’ä¸­)
  â†“
active (è¿›è¡Œä¸­)
  â†“
completed / paused (å·²å®Œæˆ/å·²æš‚åœ)
```

---

#### 3. æèµ ç®¡ç†

**è·¯å¾„**: `/admin/donations`

**åŠŸèƒ½**:
- æŸ¥çœ‹æ‰€æœ‰æèµ è®°å½•ï¼ˆå«å®Œæ•´ä¿¡æ¯ï¼‰
- æ›´æ–°æèµ çŠ¶æ€
- ä¸Šä¼ é…é€ç»“æœå›¾ç‰‡

**æƒé™æ§åˆ¶**:
```sql
-- ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æèµ 
CREATE POLICY "Admins can view all donations" ON donations
FOR SELECT TO authenticated USING (is_admin());

-- ç®¡ç†å‘˜å¯ä»¥æ›´æ–°æèµ çŠ¶æ€
CREATE POLICY "Admins can update donation status" ON donations
FOR UPDATE TO authenticated USING (is_admin());
```

**çŠ¶æ€è½¬æ¢è§„åˆ™** (æ•°æ®åº“è§¦å‘å™¨å¼ºåˆ¶æ‰§è¡Œ):

ç®¡ç†å‘˜åªèƒ½æ‰§è¡Œä»¥ä¸‹ 3 ä¸ªä¸šåŠ¡æµç¨‹è½¬æ¢ï¼š

| å½“å‰çŠ¶æ€ | å¯è½¬æ¢ä¸º | è¯´æ˜ |
|---------|---------|------|
| `paid` | `confirmed` | ç¡®è®¤æ”¶æ¬¾ |
| `confirmed` | `delivering` | å¼€å§‹é…é€ |
| `delivering` | `completed` | é…é€å®Œæˆï¼ˆéœ€ä¸Šä¼ ç»“æœå›¾ç‰‡ï¼‰ |

**ç¦æ­¢çš„è½¬æ¢** (ç”±ç³»ç»Ÿè‡ªåŠ¨å¤„ç†):
- `pending` â†’ `paid/processing/fraud_check` - WayForPay Webhook
- `refunding` â†’ `refund_processing` â†’ `refunded` - WayForPay API
- å…¶ä»–æ‰€æœ‰çŠ¶æ€è½¬æ¢ - é˜²æ­¢ç®¡ç†å‘˜è¯¯æ“ä½œ

**å­—æ®µä¿æŠ¤**:
- âœ… **å¯ç¼–è¾‘å­—æ®µ**: donation_status, donation_result_url
- âŒ **ä¸å¯ç¼–è¾‘å­—æ®µ**: id, donation_public_id, project_id, donor_name, donor_email, amount, order_reference, created_atï¼ˆè§¦å‘å™¨ä¿æŠ¤ï¼‰
- âš™ï¸ **è‡ªåŠ¨æ›´æ–°å­—æ®µ**: updated_atï¼ˆè§¦å‘å™¨è‡ªåŠ¨æ›´æ–°ï¼‰

**é…é€å®Œæˆæµç¨‹**:
1. ç®¡ç†å‘˜å°†çŠ¶æ€ä» `delivering` æ›´æ–°ä¸º `completed`
2. å¿…é¡»ä¸Šä¼ é…é€ç»“æœå›¾ç‰‡åˆ° `donation-results` å­˜å‚¨æ¡¶
3. å›¾ç‰‡ URL å­˜å‚¨åœ¨ `donation_result_url` å­—æ®µ
4. ç”¨æˆ·å¯é€šè¿‡æèµ è¿½è¸ªæŸ¥çœ‹é…é€ç…§ç‰‡

---

#### 4. Storage ç®¡ç†

**å­˜å‚¨æ¡¶**: `donation-results`

**æƒé™**:
```sql
-- ç®¡ç†å‘˜æ‹¥æœ‰å®Œæ•´ CRUD æƒé™
- INSERT: ä¸Šä¼ æ–°æ–‡ä»¶
- SELECT: æŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨
- UPDATE: æ›´æ–°æ–‡ä»¶å…ƒæ•°æ®
- DELETE: åˆ é™¤æ–‡ä»¶
```

**ä½¿ç”¨åœºæ™¯**:
- ä¸Šä¼ é…é€å®Œæˆç…§ç‰‡
- ç®¡ç†é¡¹ç›®è¿›å±•å›¾ç‰‡
- å­˜å‚¨æèµ æˆæœå±•ç¤º

**å…¬å¼€è®¿é—®**:
- âœ… æ‰€æœ‰ç”¨æˆ·å¯ä»¥æŸ¥çœ‹ï¼ˆbucket.public = trueï¼‰
- âŒ åªæœ‰ç®¡ç†å‘˜å¯ä»¥ä¸Šä¼ /åˆ é™¤

---

#### 5. å›¾åƒå¤„ç†ï¼ˆCloudinaryï¼‰

**åŠŸèƒ½**: è‡ªåŠ¨ä¼˜åŒ–ä¸Šä¼ çš„å›¾ç‰‡ï¼Œä¿æŠ¤éšç§

**å¤„ç†æµç¨‹**:

```
ç®¡ç†å‘˜ä¸Šä¼ å›¾ç‰‡
  â†“
1. ä¸Šä¼ åˆ° Cloudinaryï¼ˆä¸´æ—¶ï¼‰
  â†“
2. åº”ç”¨æ™ºèƒ½è½¬æ¢ï¼š
   â€¢ äººè„¸æ£€æµ‹å’Œæ‰“ç ï¼ˆpixelate_faces:20ï¼‰
   â€¢ æ™ºèƒ½å‹ç¼©ï¼ˆquality: auto:goodï¼‰
   â€¢ è‡ªåŠ¨æ ¼å¼ä¼˜åŒ–ï¼ˆf_autoï¼‰
   â€¢ å°ºå¯¸é™åˆ¶ï¼ˆæœ€å¤§ 1920px å®½ï¼‰
  â†“
3. ä¸‹è½½å¤„ç†åçš„å›¾ç‰‡
  â†“
4. ä¸Šä¼ åˆ° Supabase Storage
  â†“
5. åˆ é™¤ Cloudinary ä¸´æ—¶æ–‡ä»¶
  â†“
6. ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆ300px å®½ï¼‰
```

**æŠ€æœ¯å®ç°**:

```typescript
// lib/cloudinary.ts
const transformedUrl = cloudinary.url(publicId, {
  transformation: [
    { effect: 'pixelate_faces:20' },        // äººè„¸æ‰“ç 
    { width: 1920, crop: 'limit' },         // å°ºå¯¸é™åˆ¶
    {
      quality: 'auto:good',                 // æ™ºèƒ½å‹ç¼©
      fetch_format: 'auto',                 // è‡ªåŠ¨æ ¼å¼
      flags: 'lossy'                        // æœ‰æŸå‹ç¼©
    }
  ]
})
```

**å¤„ç†æ•ˆæœ**:
- âœ… **æ–‡ä»¶å¤§å°**: é€šå¸¸å‡å°‘ 50-80%ï¼ˆå‡  MB â†’ å‡ ç™¾ KBï¼‰
- âœ… **éšç§ä¿æŠ¤**: è‡ªåŠ¨æ£€æµ‹å¹¶æ¨¡ç³Šäººè„¸
- âœ… **ç”»è´¨ä¿æŒ**: auto:good æ¨¡å¼ä¿æŒé«˜è´¨é‡
- âœ… **æ ¼å¼ä¼˜åŒ–**: ç°ä»£æµè§ˆå™¨ä½¿ç”¨ WebPï¼Œæ—§æµè§ˆå™¨å›é€€åˆ° JPEG

**æ”¯æŒçš„æ–‡ä»¶ç±»å‹**:
- **å›¾ç‰‡**: JPEG, PNG, GIF, WebPï¼ˆè‡ªåŠ¨å¤„ç†ï¼‰
- **è§†é¢‘**: MP4, MOVï¼ˆç›´æ¥ä¸Šä¼ ï¼Œä¸å¤„ç†ï¼‰

**é…ç½®è¦æ±‚**:

ç¯å¢ƒå˜é‡:
```bash
NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME=your-cloud-name
CLOUDINARY_API_KEY=your-api-key
CLOUDINARY_API_SECRET=your-api-secret
```

**æµ‹è¯•å‘½ä»¤**:

```bash
# æµ‹è¯• Cloudinary åŠŸèƒ½
npm run test:cloudinary

# éœ€è¦ï¼šåœ¨é¡¹ç›®æ ¹ç›®å½•æ”¾ç½® test-image.jpg
# è¾“å‡ºï¼štest-image-processed.{format}
```

**é™çº§ç­–ç•¥**:

å¦‚æœ Cloudinary æœªé…ç½®æˆ–å¤„ç†å¤±è´¥ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å›é€€ï¼š
1. **é¦–é€‰**: ä½¿ç”¨ Sharp åº“è¿›è¡Œç®€å•å‹ç¼©ï¼ˆæ— äººè„¸æ£€æµ‹ï¼‰
2. **æœ€å**: ç›´æ¥ä¸Šä¼ åŸå›¾

è¿™ç¡®ä¿å³ä½¿ Cloudinary æœåŠ¡ä¸å¯ç”¨ï¼Œé…é€ç»“æœä¸Šä¼ åŠŸèƒ½ä»å¯æ­£å¸¸å·¥ä½œã€‚

**å¤„ç†ç‰¹æ€§**:
- ğŸ” **é‡è¯•æœºåˆ¶**: æœ€å¤šé‡è¯• 3 æ¬¡ï¼ˆCloudinary AI è½¬æ¢éœ€è¦æ—¶é—´ï¼‰
- ğŸ“Š **è¿›åº¦æ—¥å¿—**: è¯¦ç»†çš„å¤„ç†æ—¥å¿—ä¾¿äºè°ƒè¯•
- ğŸ¯ **æ™ºèƒ½é€€åŒ–**: ä¸‰å±‚é™çº§ç­–ç•¥ç¡®ä¿å¯ç”¨æ€§
- ğŸ—‘ï¸ **è‡ªåŠ¨æ¸…ç†**: å¤„ç†å®Œæˆåè‡ªåŠ¨åˆ é™¤ Cloudinary ä¸´æ—¶æ–‡ä»¶

**æ³¨æ„äº‹é¡¹**:
- âš ï¸ Cloudinary å…è´¹è®¡åˆ’é™åˆ¶ï¼š25GB å­˜å‚¨ + 25,000 æ¬¡è½¬æ¢/æœˆ
- âš ï¸ äººè„¸æ£€æµ‹ä¾èµ– Cloudinary AIï¼Œé¦–æ¬¡å¤„ç†å¯èƒ½éœ€è¦ 1-3 ç§’
- âš ï¸ è§†é¢‘æ–‡ä»¶ä¸ç»è¿‡ Cloudinary å¤„ç†ï¼ˆç›´æ¥ä¸Šä¼ ï¼‰
- âš ï¸ å»ºè®®ä¸ºç”Ÿäº§ç¯å¢ƒé…ç½® Cloudinary ä»¥è·å¾—æœ€ä½³æ•ˆæœ

---

### å®‰å…¨æœºåˆ¶

#### 1. æ•°æ®åº“ RLS ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     åŒ¿åç”¨æˆ·ï¼ˆanon keyï¼‰                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ è¯»å–é¡¹ç›®                                   â”‚
â”‚ âœ“ è¯»å–æèµ ï¼ˆè§†å›¾æ··æ·†é‚®ç®±ï¼‰                    â”‚
â”‚ âœ“ æ’å…¥å¾…æ”¯ä»˜æèµ ï¼ˆä»… pending çŠ¶æ€ï¼‰           â”‚
â”‚ âœ“ æ›´æ–° pending â†’ widget_load_failed          â”‚
â”‚ âœ— æ›´æ–°å…¶ä»–æèµ çŠ¶æ€                           â”‚
â”‚ âœ— åˆ›å»º/ç¼–è¾‘é¡¹ç›®                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç®¡ç†å‘˜ï¼ˆauthenticated + is_adminï¼‰â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ è¯»å–æ‰€æœ‰æ•°æ®ï¼ˆå«æ•æ„Ÿä¿¡æ¯ï¼‰          â”‚
â”‚ âœ“ åˆ›å»ºé¡¹ç›®                           â”‚
â”‚ âœ“ æ›´æ–°é¡¹ç›®ï¼ˆå­—æ®µå—é™ï¼‰                â”‚
â”‚ âœ“ æ›´æ–°æèµ çŠ¶æ€ï¼ˆçŠ¶æ€è½¬æ¢å—é™ï¼‰         â”‚
â”‚ âœ“ ç®¡ç† Storage                      â”‚
â”‚ âœ— åˆ é™¤é¡¹ç›®/æèµ ï¼ˆæ—  DELETE ç­–ç•¥ï¼‰     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. è§¦å‘å™¨ä¿æŠ¤

**é˜²æ­¢ä¿®æ”¹ä¸å¯å˜å­—æ®µ**:

```sql
-- Projects è¡¨è§¦å‘å™¨
CREATE TRIGGER prevent_project_immutable_fields_trigger
BEFORE UPDATE ON projects
EXECUTE FUNCTION prevent_project_immutable_fields();
-- ä¿æŠ¤å­—æ®µ:
--   â€¢ id, created_at
--   â€¢ aggregate_donations (æèµ æ¨¡å¼ï¼Œåˆ›å»ºåä¸å¯æ”¹)
--   â€¢ is_long_term (é•¿æœŸæ ‡å¿—ï¼Œåˆ›å»ºåä¸å¯æ”¹)

-- Donations è¡¨è§¦å‘å™¨ + çŠ¶æ€è½¬æ¢éªŒè¯
CREATE TRIGGER prevent_donation_immutable_fields_trigger
BEFORE UPDATE ON donations
EXECUTE FUNCTION prevent_donation_immutable_fields();
-- ä¿æŠ¤å­—æ®µ:
--   â€¢ id, donation_public_id, project_id
--   â€¢ donor_name, donor_email, amount
--   â€¢ order_reference, created_at
-- çŠ¶æ€è½¬æ¢éªŒè¯:
--   â€¢ ç®¡ç†å‘˜åªèƒ½æ‰§è¡Œ: paidâ†’confirmed, confirmedâ†’delivering, deliveringâ†’completed
--   â€¢ æœåŠ¡è§’è‰²ï¼ˆWebhookï¼‰å¯ä»¥æ‰§è¡Œä»»æ„çŠ¶æ€è½¬æ¢
```

**å¥½å¤„**:
- âœ… æ•°æ®åº“çº§å¼ºåˆ¶ä¿æŠ¤ï¼ˆæœ€é«˜å®‰å…¨çº§åˆ«ï¼‰
- âœ… å³ä½¿ RLS ç­–ç•¥è¢«ç»•è¿‡ä¹Ÿæ— æ³•ä¿®æ”¹
- âœ… é˜²æ­¢åº”ç”¨å±‚é”™è¯¯å’Œç®¡ç†å‘˜è¯¯æ“ä½œ
- âœ… çŠ¶æ€è½¬æ¢éªŒè¯ç¡®ä¿ä¸šåŠ¡æµç¨‹æ­£ç¡®æ€§

#### 3. åº”ç”¨å±‚éªŒè¯

**Server Actions åŒé‡æ£€æŸ¥**:

```typescript
// 1. æ£€æŸ¥ç®¡ç†å‘˜æƒé™
export async function updateProject(id: number, updates: ProjectUpdate) {
  await requireAdmin() // æŠ›å‡ºå¼‚å¸¸å¦‚æœæœªç™»å½•

  // 2. è¿‡æ»¤ä¸å¯å˜å­—æ®µ
  const { id: _, created_at, updated_at, ...safeUpdates } = updates

  // 3. æ‰§è¡Œæ›´æ–°
  await supabase.from('projects').update(safeUpdates).eq('id', id)
}
```

**çŠ¶æ€è½¬æ¢éªŒè¯**:

```typescript
// éªŒè¯çŠ¶æ€è½¬æ¢æ˜¯å¦åˆæ³•
const validTransitions: Record<string, string[]> = {
  refunding: ['refunded'],
  paid: ['confirmed'],
  confirmed: ['delivering'],
  delivering: ['completed'],
}

if (!validTransitions[currentStatus].includes(newStatus)) {
  throw new Error(`Invalid status transition: ${currentStatus} â†’ ${newStatus}`)
}
```

---

### ç®¡ç†å‘˜å·¥ä½œæµç¨‹

#### é¡¹ç›®åˆ›å»ºæµç¨‹

```
1. ç®¡ç†å‘˜ç™»å½• /admin/login
   â†“
2. è®¿é—® /admin/projects
   â†“
3. ç‚¹å‡»"åˆ›å»ºé¡¹ç›®"
   â†“
4. å¡«å†™é¡¹ç›®ä¿¡æ¯ï¼ˆæ”¯æŒå¤šè¯­è¨€ï¼‰
   - é¡¹ç›®åç§°ï¼ˆen/zh/uaï¼‰
   - åœ°ç‚¹ï¼ˆen/zh/uaï¼‰
   - æè¿°ï¼ˆen/zh/uaï¼‰
   - ğŸ†• é€‰æ‹©æèµ æ¨¡å¼ï¼ˆç‰©èµ„æ¨¡å¼ vs æ‰“èµæ¨¡å¼ï¼‰
   - ç›®æ ‡å•ä½æ•°ï¼ˆç‰©èµ„æ¨¡å¼ï¼‰æˆ–ç›®æ ‡é‡‘é¢ï¼ˆæ‰“èµæ¨¡å¼ï¼‰
   - å•ä½ä»·æ ¼ï¼ˆä»…ç‰©èµ„æ¨¡å¼ï¼‰
   - å•ä½åç§°ï¼ˆä»…ç‰©èµ„æ¨¡å¼ï¼‰
   - å¼€å§‹æ—¥æœŸ/ç»“æŸæ—¥æœŸ
   - æ˜¯å¦é•¿æœŸé¡¹ç›®
   â†“
5. æäº¤ â†’ createProject() Server Action
   â†“
6. RLS éªŒè¯ is_admin()
   â†“
7. æ’å…¥æ•°æ®åº“
   â”œâ”€ è§¦å‘å™¨è‡ªåŠ¨è®¾ç½® created_at, updated_at
   â””â”€ aggregate_donations å’Œ is_long_term åˆ›å»ºåä¸å¯ä¿®æ”¹ï¼ˆè§¦å‘å™¨ä¿æŠ¤ï¼‰
   â†“
8. é‡æ–°éªŒè¯é¡µé¢ç¼“å­˜
   â†“
9. é¡¹ç›®å‡ºç°åœ¨å…¬å¼€ä¸»é¡µï¼ˆæ ¹æ®æèµ æ¨¡å¼æ˜¾ç¤ºä¸åŒè¡¨å•ï¼‰
```

---

#### æèµ çŠ¶æ€ç®¡ç†æµç¨‹

```
1. ç”¨æˆ·å®Œæˆæ”¯ä»˜ â†’ çŠ¶æ€: pending
   â†“
2. Webhook ç¡®è®¤ â†’ çŠ¶æ€: paidï¼ˆå¯èƒ½ç»è¿‡ processing/fraud_checkï¼‰
   â†“
3. ç®¡ç†å‘˜æŸ¥çœ‹ /admin/donationsï¼ˆå¯ç­›é€‰çŠ¶æ€ã€é¡¹ç›®ã€æ—¥æœŸï¼‰
   â†“
4. ç¡®è®¤æ”¶æ¬¾ â†’ ç‚¹å‡»"ç¡®è®¤" â†’ paid â†’ confirmed
   â†“
5. é‡‡è´­ç‰©èµ„ â†’ ç‚¹å‡»"é…é€ä¸­" â†’ confirmed â†’ delivering
   â†“
6. é…é€å®Œæˆ â†’ ä¸Šä¼ ç…§ç‰‡
   â”œâ”€ ä¸Šä¼ åˆ° Cloudinary
   â”œâ”€ AI äººè„¸æ£€æµ‹å’Œæ‰“ç ï¼ˆpixelate_faces:20ï¼‰
   â”œâ”€ æ™ºèƒ½å‹ç¼©ï¼ˆquality: auto:goodï¼‰
   â”œâ”€ ä¸‹è½½å¤„ç†åçš„å›¾ç‰‡
   â””â”€ ä¸Šä¼ åˆ° Supabase Storage (donation-results bucket)
   â†“
7. ç‚¹å‡»"å®Œæˆ" â†’ Server Action éªŒè¯:
   - delivering â†’ completed âœ…
   - å¿…é¡»æœ‰ donation_result_url âœ…
   - æ•°æ®åº“è§¦å‘å™¨éªŒè¯çŠ¶æ€è½¬æ¢ âœ…
   â†“
8. æ›´æ–°çŠ¶æ€ â†’ çŠ¶æ€: completed
   â”œâ”€ è§¦å‘å™¨è‡ªåŠ¨æ›´æ–° updated_at
   â””â”€ é…é€ç»“æœ URL ä¿å­˜åˆ° donation_result_url å­—æ®µ
   â†“
9. ç”¨æˆ·é€šè¿‡æèµ è¿½è¸ªæŸ¥çœ‹ç»“æœå›¾ç‰‡ï¼ˆå·²ç»è¿‡éšç§ä¿æŠ¤å¤„ç†ï¼‰
```

---

### å¼€å‘æŒ‡å—

#### åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·

**æ­¥éª¤**:

1. åœ¨ Supabase Dashboard åˆ›å»ºç”¨æˆ·:
   ```
   Authentication â†’ Users â†’ Add User
   Email: admin@example.com
   Password: [secure-password]
   Email Confirm: âœ“
   ```

2. æˆ–ä½¿ç”¨ SQL:
   ```sql
   -- æ³¨æ„ï¼šéœ€è¦åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œ
   SELECT auth.admin_create_user(
     email := 'admin@example.com',
     password := 'secure-password',
     email_confirm := true
   );
   ```

3. ä½¿ç”¨è¯¥è´¦æˆ·ç™»å½• `/admin/login`

#### æœ¬åœ°æµ‹è¯•ç®¡ç†å‘˜åŠŸèƒ½

```bash
# 1. ç¡®ä¿ç¯å¢ƒå˜é‡æ­£ç¡®
NEXT_PUBLIC_SUPABASE_URL=your-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key

# 2. è¿è¡Œå¼€å‘æœåŠ¡å™¨
npm run dev

# 3. è®¿é—®ç®¡ç†å‘˜ç™»å½•é¡µ
http://localhost:3000/admin/login

# 4. ä½¿ç”¨æµ‹è¯•ç®¡ç†å‘˜è´¦æˆ·ç™»å½•
```

---

## å›½é™…åŒ–æ–¹æ¡ˆ

### æ”¯æŒçš„è¯­è¨€

| ä»£ç  | è¯­è¨€ | æ–‡ä»¶ |
|------|------|------|
| `en` | è‹±æ–‡ï¼ˆé»˜è®¤ï¼‰ | `messages/en.json` |
| `zh` | ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰ | `messages/zh.json` |
| `ua` | ä¹Œå…‹å…°è¯­ | `messages/ua.json` |

### è·¯ç”±ç»“æ„

```
/en/              â†’ è‹±æ–‡ä¸»é¡µ
/zh/              â†’ ä¸­æ–‡ä¸»é¡µ
/ua/              â†’ ä¹Œå…‹å…°è¯­ä¸»é¡µ
/en/donate        â†’ è‹±æ–‡æèµ é¡µé¢
/zh/donate        â†’ ä¸­æ–‡æèµ é¡µé¢
...
```

### ç¿»è¯‘ä½¿ç”¨æ–¹å¼

#### Server Components (æœåŠ¡ç«¯ç»„ä»¶)

```typescript
import { getTranslations } from 'next-intl/server'

export default async function Page() {
  const t = await getTranslations('namespace')
  return <h1>{t('title')}</h1>
}
```

#### Client Components (å®¢æˆ·ç«¯ç»„ä»¶)

```typescript
'use client'
import { useTranslations } from 'next-intl'

export default function Component() {
  const t = useTranslations('namespace')
  return <h1>{t('title')}</h1>
}
```

#### åŠ¨æ€å†…å®¹ï¼ˆæ•°æ®åº“ i18n å­—æ®µï¼‰

```typescript
import { getTranslatedText } from '@/lib/i18n-utils'

const projectName = getTranslatedText(
  project.project_name_i18n,
  locale,
  project.project_name // åå¤‡å€¼
)
```

### ç¿»è¯‘æ–‡ä»¶ç»“æ„

```json
{
  "common": { "..." },
  "navigation": { "..." },
  "home": { "..." },
  "donate": { "..." },
  "donateSuccess": { "..." },
  "trackDonation": { "..." },
  "footer": { "..." },
  "metadata": { "..." }
}
```

---

## å¼€å‘æŒ‡å—

### å‰ç½®è¦æ±‚

- Node.js 18+
- npm æˆ– pnpm
- Git
- Supabase è´¦æˆ·
- WayForPay å•†æˆ·è´¦æˆ·
- Resend è´¦æˆ·

### æœ¬åœ°å¼€å‘

#### 1. å…‹éš†é¡¹ç›®

```bash
git clone <repository-url>
cd NGO_web
```

#### 2. å®‰è£…ä¾èµ–

```bash
npm install
# æˆ–
pnpm install
```

#### 3. é…ç½®ç¯å¢ƒå˜é‡

åˆ›å»º `.env.local` æ–‡ä»¶:

```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJxxx...
SUPABASE_SERVICE_ROLE_KEY=eyJxxx...

# WayForPay
WAYFORPAY_MERCHANT_ACCOUNT=your_merchant_account
WAYFORPAY_SECRET_KEY=your_secret_key

# Resend
RESEND_API_KEY=re_xxx...
RESEND_FROM_EMAIL=noreply@yourdomain.com

# Cloudinary (å¯é€‰ï¼Œä½†æ¨èç”¨äºå›¾åƒå¤„ç†å’Œéšç§ä¿æŠ¤)
NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME=your-cloud-name
CLOUDINARY_API_KEY=your-api-key
CLOUDINARY_API_SECRET=your-api-secret

# App
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

#### 4. è¿è¡Œæ•°æ®åº“è¿ç§»

```bash
# ç™»å½• Supabase
npx supabase login

# é“¾æ¥é¡¹ç›®
npx supabase link --project-ref your-project-ref

# æ¨é€è¿ç§»
npx supabase db push
```

#### 5. å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
npm run dev
```

è®¿é—®: http://localhost:3000

### ä»£ç è§„èŒƒ

#### TypeScript

- ä½¿ç”¨ä¸¥æ ¼æ¨¡å¼
- ä¼˜å…ˆä½¿ç”¨ Server Components
- å¿…è¦æ—¶æ‰ä½¿ç”¨ Client Componentsï¼ˆæ·»åŠ  `'use client'` æŒ‡ä»¤ï¼‰

#### ç»„ä»¶ç¼–å†™

**Server Component ç¤ºä¾‹**:

```typescript
// app/[locale]/page.tsx
import { getTranslations } from 'next-intl/server'
import { getActiveProjects } from '@/lib/supabase/queries'

export default async function HomePage() {
  const t = await getTranslations('home')
  const projects = await getActiveProjects()

  return (
    <div>
      <h1>{t('title')}</h1>
      {/* ... */}
    </div>
  )
}
```

**Client Component ç¤ºä¾‹**:

```typescript
// components/DonationForm.tsx
'use client'
import { useTranslations } from 'next-intl'
import { useState } from 'react'

export default function DonationForm() {
  const t = useTranslations('donate')
  const [amount, setAmount] = useState(0)

  return <form>{/* ... */}</form>
}
```

#### Server Actions

```typescript
// app/actions/donation.ts
'use server'
import { z } from 'zod'

const schema = z.object({
  projectId: z.number(),
  amount: z.number().positive()
})

export async function createDonation(formData: FormData) {
  const data = schema.parse(Object.fromEntries(formData))
  // ... ä¸šåŠ¡é€»è¾‘
  return { success: true }
}
```

### é”™è¯¯å¤„ç†

#### è¡¨å•éªŒè¯

```typescript
import { z } from 'zod'

const schema = z.object({
  email: z.string().email('errors.invalidEmail')
})

try {
  const data = schema.parse(input)
} catch (err) {
  if (err instanceof z.ZodError) {
    setError(t(err.errors[0].message))
  }
}
```

#### API é”™è¯¯å¤„ç†

```typescript
try {
  const result = await createDonation(data)
} catch (err) {
  if (err instanceof Error) {
    console.error(err.message)
    setError(t('errors.serverError'))
  }
}
```

### å®‰å…¨æœ€ä½³å®è·µ

1. **æ°¸è¿œä¸è¦åœ¨å®¢æˆ·ç«¯ä½¿ç”¨ Service Role Key**
2. **æ‰€æœ‰ç”¨æˆ·è¾“å…¥å¿…é¡»éªŒè¯** (ä½¿ç”¨ Zod)
3. **Webhook å¿…é¡»éªŒè¯ç­¾å**
4. **ä½¿ç”¨ RLS ä¿æŠ¤æ•°æ®åº“**
5. **å…¬å¼€ API ä½¿ç”¨é‚®ç®±æ··æ·†è§†å›¾**

---

## éƒ¨ç½²è¯´æ˜

### Vercel éƒ¨ç½²

#### 1. æ¨é€ä»£ç åˆ° GitHub

```bash
git add .
git commit -m "Initial commit"
git push origin main
```

#### 2. åœ¨ Vercel å¯¼å…¥é¡¹ç›®

1. è®¿é—® [vercel.com](https://vercel.com)
2. ç‚¹å‡» "Import Project"
3. é€‰æ‹© GitHub ä»“åº“
4. é…ç½®é¡¹ç›®åç§°

#### 3. é…ç½®ç¯å¢ƒå˜é‡

åœ¨ Vercel é¡¹ç›®è®¾ç½®ä¸­æ·»åŠ æ‰€æœ‰ç¯å¢ƒå˜é‡:

```
NEXT_PUBLIC_SUPABASE_URL
NEXT_PUBLIC_SUPABASE_ANON_KEY
SUPABASE_SERVICE_ROLE_KEY
WAYFORPAY_MERCHANT_ACCOUNT
WAYFORPAY_SECRET_KEY
RESEND_API_KEY
RESEND_FROM_EMAIL
NEXT_PUBLIC_APP_URL
NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME
CLOUDINARY_API_KEY
CLOUDINARY_API_SECRET
```

#### 4. éƒ¨ç½²

ç‚¹å‡» "Deploy" å¼€å§‹éƒ¨ç½²ã€‚

### éƒ¨ç½²åé…ç½®

#### 1. é…ç½® WayForPay Webhook

åœ¨ WayForPay å•†æˆ·åå°è®¾ç½® Webhook URL:

```
https://yourdomain.com/api/webhooks/wayforpay
```

#### 2. é…ç½® Resend åŸŸå

åœ¨ Resend æ§åˆ¶å°:
1. æ·»åŠ å¹¶éªŒè¯åŸŸå
2. é…ç½® DNS è®°å½•ï¼ˆSPFã€DKIMã€DMARCï¼‰

**DNS è®°å½•ç¤ºä¾‹**:

```
# SPF Record
Type: TXT
Name: @
Value: v=spf1 include:_spf.resend.com ~all

# DKIM Record (ç”± Resend æä¾›)
Type: TXT
Name: resend._domainkey
Value: [Resend æä¾›çš„å€¼]

# DMARC Record
Type: TXT
Name: _dmarc
Value: v=DMARC1; p=none; rua=mailto:dmarc@yourdomain.com
```

#### 3. é…ç½® Cloudinaryï¼ˆå¯é€‰ä½†æ¨èï¼‰

**æ³¨å†Œ Cloudinary è´¦æˆ·**:

1. è®¿é—® [cloudinary.com](https://cloudinary.com) æ³¨å†Œå…è´¹è´¦æˆ·
2. è·å–é…ç½®ä¿¡æ¯ï¼ˆDashboard é¦–é¡µï¼‰:
   - Cloud Name
   - API Key
   - API Secret

**é…ç½®ç¯å¢ƒå˜é‡**:

åœ¨ Vercel é¡¹ç›®è®¾ç½®ä¸­æ·»åŠ  Cloudinary ç¯å¢ƒå˜é‡ï¼ˆå·²åœ¨æ­¥éª¤ 3 æ·»åŠ ï¼‰ã€‚

**åŠŸèƒ½è¯´æ˜**:

- âœ… **å¯ç”¨**: è‡ªåŠ¨å‹ç¼©å›¾ç‰‡ + äººè„¸æ‰“ç 
- âŒ **æœªå¯ç”¨**: ç›´æ¥ä¸Šä¼ åŸå›¾ï¼ˆåŠŸèƒ½ä»å¯æ­£å¸¸ä½¿ç”¨ï¼‰

**å…è´¹è®¡åˆ’é…é¢**:
- 25 GB å­˜å‚¨ç©ºé—´
- 25 GB æœˆæµé‡
- 25,000 æ¬¡è½¬æ¢/æœˆ

å¯¹äºä¸­å°å‹ NGOï¼Œå…è´¹è®¡åˆ’é€šå¸¸è¶³å¤Ÿä½¿ç”¨ã€‚

#### 4. æµ‹è¯•å®Œæ•´æµç¨‹

- âœ… æµ‹è¯•æèµ æµç¨‹
- âœ… æµ‹è¯• Webhook æ¥æ”¶
- âœ… æµ‹è¯•é‚®ä»¶å‘é€
- âœ… æµ‹è¯•æ‰€æœ‰è¯­è¨€ç‰ˆæœ¬
- âœ… æµ‹è¯•æèµ è¿½è¸ª
- âœ… æµ‹è¯•å›¾ç‰‡ä¸Šä¼ å’Œå¤„ç†ï¼ˆå¦‚å·²é…ç½® Cloudinaryï¼‰

---

## é™„å½•

### å¸¸è§é—®é¢˜

#### Q: å¦‚ä½•æ·»åŠ æ–°è¯­è¨€ï¼Ÿ

1. åœ¨ `messages/` ç›®å½•åˆ›å»ºæ–°çš„è¯­è¨€æ–‡ä»¶ï¼ˆå¦‚ `fr.json`ï¼‰
2. åœ¨ `i18n/config.ts` æ·»åŠ è¯­è¨€ä»£ç 
3. åœ¨ `middleware.ts` æ·»åŠ è¯­è¨€æ”¯æŒ
4. æ›´æ–° `LanguageSwitcher` ç»„ä»¶

#### Q: å¦‚ä½•æ›´æ–°æ•°æ®åº“ schemaï¼Ÿ

1. åœ¨ `supabase/migrations/` åˆ›å»ºæ–°è¿ç§»æ–‡ä»¶
2. è¿è¡Œ `supabase db push`
3. æ›´æ–° TypeScript ç±»å‹: `npx supabase gen types typescript`

#### Q: Webhook ç­¾åéªŒè¯å¤±è´¥ï¼Ÿ

æ£€æŸ¥:
1. `WAYFORPAY_SECRET_KEY` æ˜¯å¦æ­£ç¡®
2. ç­¾åå­—æ®µé¡ºåºæ˜¯å¦ä¸€è‡´
3. å­—æ®µå€¼æ˜¯å¦æœ‰é¢å¤–ç©ºæ ¼

#### Q: é‚®ä»¶å‘é€å¤±è´¥ï¼Ÿ

æ£€æŸ¥:
1. DNS è®°å½•æ˜¯å¦æ­£ç¡®é…ç½®
2. `RESEND_API_KEY` æ˜¯å¦æœ‰æ•ˆ
3. å‘ä»¶äººé‚®ç®±æ˜¯å¦å·²éªŒè¯

### ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“æ¶æ„è¯¦ç»†æ–‡æ¡£](docs/DATABASE_SCHEMA.md)
- [æœªä½¿ç”¨çš„æ•°æ®åº“å‡½æ•°åˆ†æ](docs/UNUSED_DATABASE_FUNCTIONS.md)
- [Supabase å®˜æ–¹æ–‡æ¡£](https://supabase.com/docs)
- [Next.js 14 æ–‡æ¡£](https://nextjs.org/docs)
- [next-intl æ–‡æ¡£](https://next-intl-docs.vercel.app/)

### æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿæˆ–åœ¨ GitHub ä»“åº“æäº¤ Issueã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.2.0 (æ–°å¢é‚®ä»¶è®¢é˜…ç³»ç»Ÿ + é¡¹ç›®è¯¦æƒ…é¡µæ¶æ„)
**æœ€åæ›´æ–°**: 2026-01-04
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ
